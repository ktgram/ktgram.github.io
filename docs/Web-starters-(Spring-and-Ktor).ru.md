---
---
title: Веб-стартеры (Spring и Ktor)
---

### Spring стартер

Модуль Spring Starter для библиотеки — это модуль автоматической конфигурации, который интегрирует функциональность Telegram ботов в Spring Boot приложения. Он использует мощь внедрения зависимостей Spring Boot и конфигурационных свойств для автоматической настройки Telegram ботов на основе предоставленной конфигурации. Эта библиотека особенно полезна для разработчиков, которые хотят создавать Telegram ботов с использованием Kotlin и Spring Boot, предлагая упрощенный подход к разработке и управлению ботами.

### Ключевые возможности

- **Авто-конфигурация**: Библиотека автоматически настраивает Telegram ботов на основе предоставленных конфигурационных свойств, устраняя необходимость в ручной настройке.
- **Конфигурационные свойства**: Поддерживает конфигурационные свойства для легкой настройки параметров ботов, таких как токены ботов, имена пакетов и идентификаторы.
- **Интеграция с Spring**: Бесшовно интегрируется с экосистемой Spring, используя внедрение зависимостей Spring и контекст приложения для управления экземплярами ботов.
- **Поддержка сопрограмм**: Использует Kotlin сопрограммы для асинхронных операций ботов, обеспечивая эффективное и неблокирующее выполнение.

### Начало работы

Для использования библиотеки Spring Starter для Telegram ботов вам необходимо добавить ее как зависимость в ваш Spring Boot проект. Библиотека разработана для работы с Spring Boot приложениями и требует наличия фреймворка Spring Boot для функционирования.

#### Зависимость

Добавьте следующую зависимость в файл `build.gradle` или `pom.xml`:

```gradle
dependencies {
    implementation 'eu.vendeli:spring-starter:<version>'
}
```

Замените `<version>` на последнюю версию библиотеки.

#### Конфигурация

Библиотека использует `@ConfigurationProperties` Spring Boot для привязки конфигурационных свойств. Вы можете определить конфигурацию своих ботов в файле `application.properties` или `application.yml` вашего Spring Boot приложения.

```yaml
ktgram:
 autoStartPolling: true
 shareHttpClient: true
 bot:
    - token: YOUR_BOT_TOKEN
      pckg: com.example.bot
      identifier: MyBot
```

#### Использование

После включения и настройки библиотеки она автоматически создает и настраивает экземпляры Telegram ботов на основе предоставленной конфигурации.

Она также поддерживает несколько экземпляров ботов, для инициализации нескольких просто объявите их как новые записи в разделе bot:

```yaml
ktgram:
 bot:
    - token: YOUR_BOT_TOKEN
    - token: SECOND_BOT_TOKEN
```

### Расширенная конфигурация

Для более расширенных конфигураций, таких как настройка поведения ботов или интеграция с другими компонентами Spring, вы можете расширить класс `BotConfiguration` и изменить конфигурацию бота через его метод `applyCfg`, вы можете увидеть пример [здесь](https://github.com/vendelieu/telegram-bot_template/blob/spring-bot/src/main/kotlin/com/example/springbot/configuration/BotConfig.kt).

> [!TIP]
> Для настройки каждого инициализированного экземпляра с пользовательской конфигурацией различайте их по идентификатору (класс BotConfiguration также имеет идентификатор).

### Ktor

Модуль разработан для облегчения создания веб-хука сервера для Telegram ботов. Он позволяет разработчикам настраивать сервер, включая параметры SSL/TLS, и объявлять несколько Telegram ботов с пользовательскими конфигурациями. Процесс настройки гибкий, позволяя разработчикам адаптировать сервер к своим конкретным потребностям.

### Установка

Для установки стартера ktor добавьте дополнительно к основной зависимости:

```gradle
dependencies {
    implementation("eu.vendeli:ktor-starter:x.y.z") // там
    // измените x.y.z на текущую версию библиотеки
}
```

### Ключевые компоненты

Функция `serveWebhook`

Функция serveWebhook является ядром библиотеки. Она настраивает и запускает веб-хук сервер для Telegram ботов. Она принимает два параметра:

- `wait`: Логическое значение, указывающее, должен ли сервер ждать остановки приложения перед завершением работы. По умолчанию true.
- `serverBuilder`: Лямбда-функция, которая настраивает сервер. По умолчанию пустая лямбда.

### Конфигурация

* `WEBHOOK_PREFIX`: это параметр, который будет использоваться в качестве префикса адреса для маршрута прослушивания веб-хука. (по умолчанию "/")

#### Настройка сервера

- `server`: Метод для настройки конфигурации сервера с использованием либо EnvConfiguration, либо ManualConfiguration.
- `engine`: Метод для настройки Netty приложения engine.
- `ktorModule`: Метод для добавления Ktor модулей в приложение.

Библиотека предоставляет широкий спектр настраиваемых параметров для сервера, включая хост, порт, настройки SSL и многое другое. Есть два конкретных варианта для его настройки:

* `EnvConfiguration`: Считывает значения конфигурации из окружения с префиксом `KTGRAM_`.
* `ManualConfiguration`: Позволяет вручную устанавливать значения конфигурации, установите ваши параметры в функции `server {}`.

Вот список параметров, которые могут быть установлены:

- `HOST`: Имя хоста или IP-адрес сервера.
- `PORT`: Номер порта для сервера.
- `SSL_PORT`: Номер порта для SSL/TLS соединений.
- `PEM_PRIVATE_KEY_PATH`: Путь к файлу PEM закрытого ключа.
- `PEM_CHAIN_PATH`: Путь к файлу PEM цепочки сертификатов.
- `PEM_PRIVATE_KEY`: ПАРОЛЬ PEM закрытого ключа в виде массива символов.
- `KEYSTORE_PATH`: Путь к файлу Java KeyStore.
- `KEYSTORE_PASSWORD`: Пароль для KeyStore.
- `KEY_ALIAS`: Псевдоним для ключа в KeyStore.
- `SSL_ON`: Логическое значение, указывающее, должен ли быть включен SSL/TLS. По умолчанию true.

> [!TIP]
> Если присутствуют PEM сертификаты, модуль сам создаст хранилище JKS из них по указанному пути.

#### Конфигурация бота:

Для настройки бота вызовите `declareBot {}` который имеет такие параметры:

- `token`: Токен бота.
- `pckg`: Имя пакета для бота.
- `configuration`: Лямбда-функция для настройки бота.
- `handlingBehaviour`: Лямбда-функция для установки поведения обработки бота.
- `onInit`: Лямбда-функция, которая будет выполнена при инициализации бота.

### Пример использования

Для использования этого модуля вызовите функцию `serveWebhook`, настройте его с вашими желаемыми параметрами, объявите ваших ботов. Вот упрощенный пример:

```kotlin
fun main() = runBlocking {
    serveWebhook {
        server {
            HOST = "0.0.0.0"
            PORT = 8080
            SSL_PORT = 8443

            PEM_PRIVATE_KEY_PATH = "/etc/letsencrypt/live/example.com/privkey.pem"
            PEM_CHAIN_PATH = "/etc/letsencrypt/live/example.com/fullchain.pem"
            PEM_PRIVATE_KEY = "pem_changeit".toCharArray()

            KEYSTORE_PATH = "/etc/ssl/certs/java/cacerts/bot_keystore.jks"
            KEYSTORE_PASSWORD = "changeit".toCharArray()
            // Установите другие параметры конфигурации по мере необходимости
        }
        declareBot {
            token = "YOUR_BOT_TOKEN"
            // Настройте другие параметры бота
        }
        // Добавьте больше ботов или установите другие параметры при необходимости
    }
}
```

> [!CAUTION]
> Не забудьте установить веб-хук, чтобы все работало. :)

По умолчанию модуль будет обслуживать конечные точки прослушивания веб-хука как `host/BOT_TOKEN`


---