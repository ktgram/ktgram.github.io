---
---
title: Обработчики
---


### Разнообразие обработчиков

В разработке ботов, особенно в системах, включающих взаимодействие с пользователями, крайне важно эффективно управлять и обрабатывать команды и события.

Эти аннотации помечают функции, предназначенные для обработки конкретных команд, входных данных или обновлений, и предоставляют метаданные, такие как ключевые слова команд, области видимости и стражи.

### Обзор аннотаций

#### CommandHandler

Аннотация `CommandHandler` используется для пометки функций, которые обрабатывают конкретные команды. Эта аннотация включает свойства, определяющие ключевые слова и области видимости команды.

-   **value**: Указывает ключевые слова, связанные с командой.
-   **scope**: Определяет контекст или область видимости, в которой будет проверяться команда.

```kotlin
@CommandHandler(["text"])
suspend fun test(user: User, bot: TelegramBot) {
    //...
}
```

##### CommandHandler.CallbackQuery

Специализированная версия аннотации `CommandHandler`, предназначенная специально для обработки callback-запросов. Она включает аналогичные свойства, как `CommandHandler`, с фокусом на команды, связанные с callback-запросами.

_Это фактически то же самое, что и просто `@CommandHandler` с предустановленной областью видимости `UpdateType.CALLBACK_QUERY`_.

-   **value**: Указывает ключевые слова, связанные с командой.
-   **autoAnswer**: Автоматически отвечать на `callbackQuery` (вызывать `answerCallbackQuery` перед обработкой).


```kotlin
@CommandHandler.CallbackQuery(["text"])
suspend fun test(user: User, bot: TelegramBot) {
    //...
}
```

#### CommonHandler

Аннотация `CommonHandler` предназначена для функций, которые обрабатывают команды с более низким приоритетом по сравнению с `CommandHandler` и `InputHandler`. Она используется на уровне источника и предоставляет гибкий способ определения общих обработчиков команд.

**Обратите внимание, что приоритет работает только внутри `@CommonHandler` (т.е. не влияет на другие обработчики).**

##### CommonHandler.Text

Эта аннотация определяет сопоставление текста с обновлениями. Она включает свойства для определения сопоставляемого текста, условий фильтрации, приоритета и области видимости.

-   **value**: Текст для сопоставления с входящими обновлениями.
-   **filter**: Класс, определяющий условия, используемые в процессе сопоставления.
-   **priority**: Уровень приоритета обработчика, где 0 - наивысший приоритет.
-   **scope**: Контекст или область видимости, в которой будет проверяться сопоставление текста.

```kotlin
@CommonHandler.Text(["text"], filter = isNewUserFilter::class, priority = 10)
suspend fun test(user: User, bot: TelegramBot) {
    //...
}
```

##### CommonHandler.Regex

Подобно `CommonHandler.Text`, эта аннотация используется для сопоставления обновлений на основе регулярных выражений. Она включает свойства для определения шаблона регулярного выражения, опций, условий фильтрации, приоритета и области видимости.

-   **value**: Шаблон регулярного выражения, используемый для сопоставления.
-   **options**: Опции регулярного выражения, изменяющие поведение шаблона.
-   **filter**: Класс, определяющий условия, используемые в процессе сопоставления.
-   **priority**: Уровень приоритета обработчика, где 0 - наивысший приоритет.
-   **scope**: Контекст или область видимости, в которой будет проверяться сопоставление регулярного выражения.

```kotlin
@CommonHandler.Regex("^\d+$", scope = [UpdateType.EDITED_MESSAGE])
suspend fun test(update: EditedMessageUpdate, user: User, bot: TelegramBot) {
    //...
}
```

#### InputHandler

Аннотация `InputHandler` помечает функции, которые обрабатывают конкретные события ввода. Она предназначена для функций, которые обрабатывают входные данные во время выполнения, и включает свойства для определения ключевых слов ввода и областей видимости.

-   **value**: Указывает ключевые слова, связанные с событием ввода.

```kotlin
@InputHandler("text")
suspend fun test(update: ProcessedUpdate, user: User, bot: TelegramBot) {
    //...
}
```

#### UnprocessedHandler

Аннотация `UnprocessedHandler` используется для пометки функций, которые обрабатывают обновления, не обработанные другими обработчиками. Она обеспечивает, чтобы любые необработанные обновления управлялись соответствующим образом, с возможностью только одной точки обработки для этого типа обработчика.

```kotlin
@UnprocessedHandler
suspend fun test(update: ProcessedUpdate, user: User, bot: TelegramBot) {
    //...
}
```

#### UpdateHandler

Аннотация `UpdateHandler` помечает функции, которые обрабатывают конкретные типы входящих обновлений. Она предоставляет способ систематической категоризации и обработки различных типов обновлений.

-   **type**: Указывает типы обновлений, которые будет обрабатывать функция обработчика.

```kotlin
@UpdateHandler([UpdateType.PRE_CHECKOUT_QUERY])
suspend fun test(update: PreCheckoutQueryUpdate, user: User, bot: TelegramBot) {
    //...
}
```
### Сопутствующие аннотации обработчиков

Существуют также дополнительные аннотации, которые являются необязательными для обработчиков, дополняя необязательное поведение самих обработчиков.

Их можно размещать как на функциях, к которым применяется обработчик, так и на классах, в последнем случае они будут автоматически применены ко всем обработчикам в этом классе, но если есть необходимость, можно иметь отдельное поведение для некоторых функций.

Т.е. применение имеет такой приоритет: `Function` > `Class`, где функция имеет более высокий приоритет.

#### Ограничение частоты

Кроме того, давайте также раскроем механизм ограничения частоты, описанный в аннотациях.

Вы можете установить общие лимиты для каждого пользователя:

```kotlin
// ...
val bot = TelegramBot("BOT_TOKEN") {
    rateLimiter { // общие лимиты
        limits = RateLimits(period = 10000, rate = 5)
    }
}
```

###### Специфичные для обработчика

Лимиты на определенные действия могут быть определены с помощью аннотации `RateLimits`, поддерживаемой `@CommandHandler`, `@CommandHandler.CallbackQuery`, `@InputHandler`, `@CommonHandler`.

```kotlin
@CommandHandler(["/start"])
@RateLimits(period = 1000L, rate = 1L)
suspend fun start(user: User, bot: TelegramBot) {
    // ...
}
```

#### Стража

Вы можете определять стражи отдельно для контроля доступа к обработчикам, поддерживается `@CommandHandler`, `@CommandHandler.CallbackQuery`, `@InputHandler` :

```kotlin
@CommandHandler(["text"])
@Guard(isAdminGuard::class)
suspend fun test(user: User, bot: TelegramBot) {
    //...
}
```

#### ArgParser

Вы можете определять пользовательский парсер аргументов отдельно для изменения поведения парсинга параметров для обработчиков, поддерживается `@CommandHandler`, `@CommandHandler.CallbackQuery`, `@CommonHandler`:

```kotlin
@CommandHandler(["text"])
@ArgParser(SpaceArgParser::class)
suspend fun test(user: User, bot: TelegramBot) {
    //...
}
```

**см. также [`defaultArgParser`](https://vendelieu.github.io/telegram-bot/telegram-bot/eu.vendeli.tgbot.utils.common/default-arg-parser.html)**

### Заключение

Эти аннотации предоставляют надежные и гибкие инструменты для обработки команд, входных данных и событий, позволяя при этом отдельную конфигурацию лимитов частоты и стражей, что повышает общую структуру и поддерживаемость разработки ботов.

### См. также

* [Действия и процессоры](Activites-and-Processors.md)
* [Вызов действия](Activity-invocation.md)
* [FSM и обработка диалогов](FSM-and-Conversation-handling.md)
* [Парсинг обновлений](Update-parsing.md)
* [Помощник](Aide.md)