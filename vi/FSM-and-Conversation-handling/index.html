<!doctype html><html class=no-js lang=vi><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta content="Telegram Bot API wrapper with handy Kotlin DSL." name=description><link href=https://tgbot.vendeli.eu/vi/FSM-and-Conversation-handling/ rel=canonical><link href=../F.A.Q/ rel=prev><link href=../Functional-DSL/ rel=next><link href=../../FSM-and-Conversation-handling/ hreflang=en rel=alternate><link href=../../zh/FSM-and-Conversation-handling/ hreflang=zh rel=alternate><link href=../../hi/FSM-and-Conversation-handling/ hreflang=hi rel=alternate><link href=../../ru/FSM-and-Conversation-handling/ hreflang=ru rel=alternate><link href=../../ko/FSM-and-Conversation-handling/ hreflang=ko rel=alternate><link href=../../fa/FSM-and-Conversation-handling/ hreflang=fa rel=alternate><link href=../../pt/FSM-and-Conversation-handling/ hreflang=pt rel=alternate><link href=../../id/FSM-and-Conversation-handling/ hreflang=id rel=alternate><link href=./ hreflang=vi rel=alternate><link href=../../assets/img/lib-logo.png rel=icon><meta content="mkdocs-1.6.1, mkdocs-material-9.7.1" name=generator><title>Xử Lý FSM Và Hội Thoại - Telegram bot</title><link href=../../assets/stylesheets/main.484c7ddc.min.css rel=stylesheet><link href=../../assets/stylesheets/palette.ab4e12ef.min.css rel=stylesheet><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback" rel=stylesheet><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link href=../../assets/stylesheets/extra.css rel=stylesheet><script>__md_scope=new URL(`../..`,location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+`.`+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+`.`+e,JSON.stringify(_))}catch{}};</script><body data-md-color-accent=indigo data-md-color-primary=indigo data-md-color-scheme=slate dir=ltr><input autocomplete=off class=md-toggle data-md-toggle=drawer id=__drawer type=checkbox><input autocomplete=off class=md-toggle data-md-toggle=search id=__search type=checkbox><label class=md-overlay for=__drawer></label><div data-md-component=skip><a class=md-skip href=#ve-mat-ly-thuyet> Bỏ qua </a></div><div data-md-component=announce></div><header class=md-header data-md-component=header><nav aria-label="Đầu trang" class="md-header__inner md-grid"><a aria-label="Telegram bot" class="md-header__button md-logo" title="Telegram bot" data-md-component=logo href=../> <img alt=logo src=../../assets/img/lib-logo.png> </a><label class="md-header__button md-icon" for=__drawer><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg></label><div class=md-header__title data-md-component=header-title><div class=md-header__ellipsis><div class=md-header__topic><span class=md-ellipsis> Telegram bot </span></div><div class=md-header__topic data-md-component=header-topic><span class=md-ellipsis> Xử Lý FSM Và Hội Thoại </span></div></div></div><form class=md-header__option data-md-component=palette><input aria-label="Switch to light mode" data-md-color-media="(prefers-color-scheme: dark)" class=md-option data-md-color-accent=indigo data-md-color-primary=indigo data-md-color-scheme=slate id=__palette_0 name=__palette type=radio><label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg></label><input aria-label="Switch to dark mode" data-md-color-media="(prefers-color-scheme: light)" class=md-option data-md-color-accent=indigo data-md-color-primary=indigo data-md-color-scheme=default id=__palette_1 name=__palette type=radio><label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_0 hidden><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg></label></form><script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script><div class=md-header__option><div class=md-select><button aria-label="Chọn ngôn ngữ" class="md-header__button md-icon"><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg></button><div class=md-select__inner><ul class=md-select__list><li class=md-select__item><a class=md-select__link href=../../FSM-and-Conversation-handling/ hreflang=en> English </a><li class=md-select__item><a class=md-select__link href=../../zh/FSM-and-Conversation-handling/ hreflang=zh> 中文 </a><li class=md-select__item><a class=md-select__link href=../../hi/FSM-and-Conversation-handling/ hreflang=hi> हिन्दी </a><li class=md-select__item><a class=md-select__link href=../../ru/FSM-and-Conversation-handling/ hreflang=ru> Русский </a><li class=md-select__item><a class=md-select__link href=../../ko/FSM-and-Conversation-handling/ hreflang=ko> 한국어 </a><li class=md-select__item><a class=md-select__link href=../../fa/FSM-and-Conversation-handling/ hreflang=fa> فارسی </a><li class=md-select__item><a class=md-select__link href=../../pt/FSM-and-Conversation-handling/ hreflang=pt> Português </a><li class=md-select__item><a class=md-select__link href=../../id/FSM-and-Conversation-handling/ hreflang=id> Bahasa Indonesia </a><li class=md-select__item><a class=md-select__link href=./ hreflang=vi> Tiếng Việt </a></ul></div></div></div><label class="md-header__button md-icon" for=__search><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg></label><div class=md-search data-md-component=search role=dialog><label class=md-search__overlay for=__search></label><div class=md-search__inner role=search><form class=md-search__form name=search><input aria-label="Tìm kiếm" placeholder="Tìm kiếm" autocapitalize=off autocomplete=off autocorrect=off class=md-search__input data-md-component=search-query name=query required spellcheck=false type=text><label class="md-search__icon md-icon" for=__search><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg></label><nav aria-label="Tìm kiếm" class=md-search__options><a aria-label="Chia sẻ" class="md-search__icon md-icon" title="Chia sẻ" data-clipboard data-clipboard-text data-md-component=search-share href=javascript:void(0) tabindex=-1> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a><button class="md-search__icon md-icon" aria-label=Xoá tabindex=-1 title=Xoá type=reset><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></nav></form><div class=md-search__output><div class=md-search__scrollwrap data-md-scrollfix tabindex=0><div class=md-search-result data-md-component=search-result><div class=md-search-result__meta>Initializing search</div><ol class=md-search-result__list role=presentation></ol></div></div></div></div></div><div class=md-header__source><a title="Xem mã nguồn" class=md-source data-md-component=source href=https://github.com/vendelieu/telegram-bot> <div class="md-source__icon md-icon"><svg viewbox="0 0 512 512" xmlns=http://www.w3.org/2000/svg><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg></div> <div class=md-source__repository>vendelieu/telegram-bot</div> </a></div></nav></header><div class=md-container data-md-component=container><nav aria-label=Tabs class=md-tabs data-md-component=tabs><div class=md-grid><ul class=md-tabs__list><li class=md-tabs__item><a class=md-tabs__link href=../> Home </a><li class="md-tabs__item md-tabs__item--active"><a class=md-tabs__link href=../Actions/> Documentation </a><li class=md-tabs__item><a class=md-tabs__link href=https://vendelieu.github.io/telegram-bot/> API Reference </a></ul></div></nav><main class=md-main data-md-component=main><div class="md-main__inner md-grid"><div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation><div class=md-sidebar__scrollwrap><div class=md-sidebar__inner><nav aria-label="Thanh điều hướng" class="md-nav md-nav--primary md-nav--lifted" data-md-level=0><label class=md-nav__title for=__drawer><a aria-label="Telegram bot" class="md-nav__button md-logo" title="Telegram bot" data-md-component=logo href=../> <img alt=logo src=../../assets/img/lib-logo.png> </a> Telegram bot</label><div class=md-nav__source><a title="Xem mã nguồn" class=md-source data-md-component=source href=https://github.com/vendelieu/telegram-bot> <div class="md-source__icon md-icon"><svg viewbox="0 0 512 512" xmlns=http://www.w3.org/2000/svg><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg></div> <div class=md-source__repository>vendelieu/telegram-bot</div> </a></div><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=../> <span class=md-ellipsis> Home </span> </a><li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle" checked id=__nav_2 type=checkbox> <label class=md-nav__link for=__nav_2 id=__nav_2_label><span class=md-ellipsis> Documentation </span> <span class="md-nav__icon md-icon"></span></label> <nav aria-expanded=true aria-labelledby=__nav_2_label class=md-nav data-md-level=1><label class=md-nav__title for=__nav_2><span class="md-nav__icon md-icon"></span> Documentation</label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=../Actions/> <span class=md-ellipsis> Actions </span> </a><li class=md-nav__item><a class=md-nav__link href=../Activites-and-Processors/> <span class=md-ellipsis> Hoạt động và Bộ xử lý </span> </a><li class=md-nav__item><a class=md-nav__link href=../Activity-invocation/> <span class=md-ellipsis> Activity Invocation </span> </a><li class=md-nav__item><a class=md-nav__link href=../Bot-Context/> <span class=md-ellipsis> Ngữ cảnh Bot </span> </a><li class=md-nav__item><a class=md-nav__link href=../Bot-configuration/> <span class=md-ellipsis> Cấu hình Bot </span> </a><li class=md-nav__item><a class=md-nav__link href=../F.A.Q/> <span class=md-ellipsis> Câu hỏi thường gặp </span> </a><li class="md-nav__item md-nav__item--active"><input class="md-nav__toggle md-toggle" id=__toc type=checkbox> <label class="md-nav__link md-nav__link--active" for=__toc><span class=md-ellipsis> Xử Lý FSM Và Hội Thoại </span> <span class="md-nav__icon md-icon"></span></label> <a class="md-nav__link md-nav__link--active" href=./> <span class=md-ellipsis> Xử Lý FSM Và Hội Thoại </span> </a> <nav aria-label="On this page" class="md-nav md-nav--secondary"><label class=md-nav__title for=__toc><span class="md-nav__icon md-icon"></span> On this page</label><ul class=md-nav__list data-md-component=toc data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=#ve-mat-ly-thuyet> <span class=md-ellipsis> Về mặt lý thuyết </span> </a><li class=md-nav__item><a class=md-nav__link href=#trong-thuc-te> <span class=md-ellipsis> Trong thực tế </span> </a><li class=md-nav__item><a class=md-nav__link href=#cac-khai-niem-cot-loi> <span class=md-ellipsis> Các Khái Niệm Cốt Lõi </span> </a> <nav aria-label="Các Khái Niệm Cốt Lõi" class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#wizardstep> <span class=md-ellipsis> WizardStep </span> </a><li class=md-nav__item><a class=md-nav__link href=#transition> <span class=md-ellipsis> Transition </span> </a><li class=md-nav__item><a class=md-nav__link href=#wizardcontext> <span class=md-ellipsis> WizardContext </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=#inh-nghia-mot-wizard> <span class=md-ellipsis> Định Nghĩa Một Wizard </span> </a> <nav aria-label="Định Nghĩa Một Wizard" class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#cau-truc-co-ban> <span class=md-ellipsis> Cấu Trúc Cơ Bản </span> </a><li class=md-nav__item><a class=md-nav__link href=#tham-so-chu-thich> <span class=md-ellipsis> Tham Số Chú Thích </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=#quan-ly-trang-thai> <span class=md-ellipsis> Quản Lý Trạng Thái </span> </a> <nav aria-label="Quản Lý Trạng Thái" class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#wizardstatemanager> <span class=md-ellipsis> WizardStateManager </span> </a><li class=md-nav__item><a class=md-nav__link href=#ghep-oi-tu-ong> <span class=md-ellipsis> Ghép Đôi Tự Động </span> </a><li class=md-nav__item><a class=md-nav__link href=#ghi-e-theo-buoc> <span class=md-ellipsis> Ghi Đè Theo Bước </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=#truy-cap-trang-thai-an-toan-kieu> <span class=md-ellipsis> Truy Cập Trạng Thái An Toàn Kiểu </span> </a> <nav aria-label="Truy Cập Trạng Thái An Toàn Kiểu" class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#ham-uoc-tao> <span class=md-ellipsis> Hàm Được Tạo </span> </a><li class=md-nav__item><a class=md-nav__link href=#cach-su-dung> <span class=md-ellipsis> Cách Sử Dụng </span> </a><li class=md-nav__item><a class=md-nav__link href=#phuong-thuc-du-phong> <span class=md-ellipsis> Phương Thức Dự Phòng </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=#vi-du-hoan-chinh> <span class=md-ellipsis> Ví Dụ Hoàn Chỉnh </span> </a> <nav aria-label="Ví Dụ Hoàn Chỉnh" class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#wizard-ang-ky-nguoi-dung> <span class=md-ellipsis> Wizard Đăng Ký Người Dùng </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=#tinh-nang-nang-cao> <span class=md-ellipsis> Tính Năng Nâng Cao </span> </a> <nav aria-label="Tính Năng Nâng Cao" class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#chuyen-tiep-co-ieu-kien> <span class=md-ellipsis> Chuyển Tiếp Có Điều Kiện </span> </a><li class=md-nav__item><a class=md-nav__link href=#cac-buoc-khong-co-trang-thai> <span class=md-ellipsis> Các Bước Không Có Trạng Thái </span> </a><li class=md-nav__item><a class=md-nav__link href=#trinh-quan-ly-trang-thai-tuy-chinh> <span class=md-ellipsis> Trình Quản Lý Trạng Thái Tùy Chỉnh </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=#cach-no-hoat-ong-ben-trong> <span class=md-ellipsis> Cách Nó Hoạt Động Bên Trong </span> </a> <nav aria-label="Cách Nó Hoạt Động Bên Trong" class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#tao-ma> <span class=md-ellipsis> Tạo Mã </span> </a><li class=md-nav__item><a class=md-nav__link href=#luong> <span class=md-ellipsis> Luồng </span> </a><li class=md-nav__item><a class=md-nav__link href=#luu-tru-trang-thai> <span class=md-ellipsis> Lưu Trữ Trạng Thái </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=#thuc-hanh-tot-nhat> <span class=md-ellipsis> Thực Hành Tốt Nhất </span> </a> <nav aria-label="Thực Hành Tốt Nhất" class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#1-luon-cung-cap-loi-nhac-ro-rang> <span class=md-ellipsis> 1. Luôn Cung Cấp Lời Nhắc Rõ Ràng </span> </a><li class=md-nav__item><a class=md-nav__link href=#2-xu-ly-loi-xac-thuc-mot-cach-lich-su> <span class=md-ellipsis> 2. Xử Lý Lỗi Xác Thực Một Cách Lịch Sự </span> </a><li class=md-nav__item><a class=md-nav__link href=#3-su-dung-truy-cap-trang-thai-an-toan-kieu> <span class=md-ellipsis> 3. Sử Dụng Truy Cập Trạng Thái An Toàn Kiểu </span> </a><li class=md-nav__item><a class=md-nav__link href=#4-giu-cac-buoc-tap-trung> <span class=md-ellipsis> 4. Giữ Các Bước Tập Trung </span> </a><li class=md-nav__item><a class=md-nav__link href=#5-su-dung-ten-buoc-co-y-nghia> <span class=md-ellipsis> 5. Sử Dụng Tên Bước Có Ý Nghĩa </span> </a><li class=md-nav__item><a class=md-nav__link href=#6-don-dep-trang-thai-khi-can> <span class=md-ellipsis> 6. Dọn Dẹp Trạng Thái Khi Cần </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=#tom-tat> <span class=md-ellipsis> Tóm Tắt </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=../Functional-DSL/> <span class=md-ellipsis> Functional Dsl </span> </a><li class=md-nav__item><a class=md-nav__link href=../Guards/> <span class=md-ellipsis> Guards </span> </a><li class=md-nav__item><a class=md-nav__link href=../Handlers/> <span class=md-ellipsis> Handlers </span> </a><li class=md-nav__item><a class=md-nav__link href=../Interceptors-%28middleware%29/> <span class=md-ellipsis> Interceptors (Middleware) </span> </a><li class=md-nav__item><a class=md-nav__link href=../Update-parsing/> <span class=md-ellipsis> Cập nhật Phân tích Văn bản </span> </a><li class=md-nav__item><a class=md-nav__link href=../Useful-utilities-and-tips/> <span class=md-ellipsis> Tiện ích Hữu ích và Mẹo </span> </a><li class=md-nav__item><a class=md-nav__link href=../Web-starters-%28Spring-and-Ktor%29/> <span class=md-ellipsis> Web Starters (Spring And Ktor) </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=https://vendelieu.github.io/telegram-bot/> <span class=md-ellipsis> API Reference </span> </a></ul></nav></div></div></div><div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc><div class=md-sidebar__scrollwrap><div class=md-sidebar__inner><nav aria-label="On this page" class="md-nav md-nav--secondary"><label class=md-nav__title for=__toc><span class="md-nav__icon md-icon"></span> On this page</label><ul class=md-nav__list data-md-component=toc data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=#ve-mat-ly-thuyet> <span class=md-ellipsis> Về mặt lý thuyết </span> </a><li class=md-nav__item><a class=md-nav__link href=#trong-thuc-te> <span class=md-ellipsis> Trong thực tế </span> </a><li class=md-nav__item><a class=md-nav__link href=#cac-khai-niem-cot-loi> <span class=md-ellipsis> Các Khái Niệm Cốt Lõi </span> </a> <nav aria-label="Các Khái Niệm Cốt Lõi" class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#wizardstep> <span class=md-ellipsis> WizardStep </span> </a><li class=md-nav__item><a class=md-nav__link href=#transition> <span class=md-ellipsis> Transition </span> </a><li class=md-nav__item><a class=md-nav__link href=#wizardcontext> <span class=md-ellipsis> WizardContext </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=#inh-nghia-mot-wizard> <span class=md-ellipsis> Định Nghĩa Một Wizard </span> </a> <nav aria-label="Định Nghĩa Một Wizard" class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#cau-truc-co-ban> <span class=md-ellipsis> Cấu Trúc Cơ Bản </span> </a><li class=md-nav__item><a class=md-nav__link href=#tham-so-chu-thich> <span class=md-ellipsis> Tham Số Chú Thích </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=#quan-ly-trang-thai> <span class=md-ellipsis> Quản Lý Trạng Thái </span> </a> <nav aria-label="Quản Lý Trạng Thái" class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#wizardstatemanager> <span class=md-ellipsis> WizardStateManager </span> </a><li class=md-nav__item><a class=md-nav__link href=#ghep-oi-tu-ong> <span class=md-ellipsis> Ghép Đôi Tự Động </span> </a><li class=md-nav__item><a class=md-nav__link href=#ghi-e-theo-buoc> <span class=md-ellipsis> Ghi Đè Theo Bước </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=#truy-cap-trang-thai-an-toan-kieu> <span class=md-ellipsis> Truy Cập Trạng Thái An Toàn Kiểu </span> </a> <nav aria-label="Truy Cập Trạng Thái An Toàn Kiểu" class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#ham-uoc-tao> <span class=md-ellipsis> Hàm Được Tạo </span> </a><li class=md-nav__item><a class=md-nav__link href=#cach-su-dung> <span class=md-ellipsis> Cách Sử Dụng </span> </a><li class=md-nav__item><a class=md-nav__link href=#phuong-thuc-du-phong> <span class=md-ellipsis> Phương Thức Dự Phòng </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=#vi-du-hoan-chinh> <span class=md-ellipsis> Ví Dụ Hoàn Chỉnh </span> </a> <nav aria-label="Ví Dụ Hoàn Chỉnh" class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#wizard-ang-ky-nguoi-dung> <span class=md-ellipsis> Wizard Đăng Ký Người Dùng </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=#tinh-nang-nang-cao> <span class=md-ellipsis> Tính Năng Nâng Cao </span> </a> <nav aria-label="Tính Năng Nâng Cao" class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#chuyen-tiep-co-ieu-kien> <span class=md-ellipsis> Chuyển Tiếp Có Điều Kiện </span> </a><li class=md-nav__item><a class=md-nav__link href=#cac-buoc-khong-co-trang-thai> <span class=md-ellipsis> Các Bước Không Có Trạng Thái </span> </a><li class=md-nav__item><a class=md-nav__link href=#trinh-quan-ly-trang-thai-tuy-chinh> <span class=md-ellipsis> Trình Quản Lý Trạng Thái Tùy Chỉnh </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=#cach-no-hoat-ong-ben-trong> <span class=md-ellipsis> Cách Nó Hoạt Động Bên Trong </span> </a> <nav aria-label="Cách Nó Hoạt Động Bên Trong" class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#tao-ma> <span class=md-ellipsis> Tạo Mã </span> </a><li class=md-nav__item><a class=md-nav__link href=#luong> <span class=md-ellipsis> Luồng </span> </a><li class=md-nav__item><a class=md-nav__link href=#luu-tru-trang-thai> <span class=md-ellipsis> Lưu Trữ Trạng Thái </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=#thuc-hanh-tot-nhat> <span class=md-ellipsis> Thực Hành Tốt Nhất </span> </a> <nav aria-label="Thực Hành Tốt Nhất" class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#1-luon-cung-cap-loi-nhac-ro-rang> <span class=md-ellipsis> 1. Luôn Cung Cấp Lời Nhắc Rõ Ràng </span> </a><li class=md-nav__item><a class=md-nav__link href=#2-xu-ly-loi-xac-thuc-mot-cach-lich-su> <span class=md-ellipsis> 2. Xử Lý Lỗi Xác Thực Một Cách Lịch Sự </span> </a><li class=md-nav__item><a class=md-nav__link href=#3-su-dung-truy-cap-trang-thai-an-toan-kieu> <span class=md-ellipsis> 3. Sử Dụng Truy Cập Trạng Thái An Toàn Kiểu </span> </a><li class=md-nav__item><a class=md-nav__link href=#4-giu-cac-buoc-tap-trung> <span class=md-ellipsis> 4. Giữ Các Bước Tập Trung </span> </a><li class=md-nav__item><a class=md-nav__link href=#5-su-dung-ten-buoc-co-y-nghia> <span class=md-ellipsis> 5. Sử Dụng Tên Bước Có Ý Nghĩa </span> </a><li class=md-nav__item><a class=md-nav__link href=#6-don-dep-trang-thai-khi-can> <span class=md-ellipsis> 6. Dọn Dẹp Trạng Thái Khi Cần </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=#tom-tat> <span class=md-ellipsis> Tóm Tắt </span> </a></ul></nav></div></div></div><div class=md-content data-md-component=content><article class="md-content__inner md-typeset"><h1>Xử Lý FSM Và Hội Thoại</h1><p>Thư viện cũng hỗ trợ cơ chế FSM, đây là cơ chế xử lý tiến bộ đầu vào của người dùng với việc xử lý đầu vào không chính xác.<div class="admonition note"><p class=admonition-title>Note<p>TL;DR: Xem ví dụ <a href=https://github.com/vendelieu/telegram-bot_template/tree/conversation>ở đó</a>.</div><h3 id=ve-mat-ly-thuyet>Về mặt lý thuyết<a title="Permanent link" class=headerlink href=#ve-mat-ly-thuyet>¶</a></h3><p>Hãy tưởng tượng một tình huống bạn cần thu thập khảo sát người dùng, bạn có thể hỏi tất cả dữ liệu của một người trong một bước, nhưng với đầu vào không chính xác của một trong các tham số, nó sẽ khó khăn cả cho người dùng và cho chúng ta, và mỗi bước có thể khác nhau tùy thuộc vào một số dữ liệu đầu vào nhất định.<p>Bây giờ hãy tưởng tượng đầu vào từng bước của dữ liệu, nơi bot đi vào chế độ hội thoại với người dùng.<p align=center><img alt="Sơ đồ quá trình xử lý" src=https://github.com/vendelieu/telegram-bot/assets/3987067/2e84fa00-e59c-4352-8665-83be3b971e7b><p>Mũi tên màu xanh lá cây chỉ quá trình chuyển tiếp qua các bước không có lỗi, mũi tên màu xanh dương có nghĩa là lưu trạng thái hiện tại và chờ nhập lại (ví dụ: nếu người dùng chỉ ra rằng anh ta -100 tuổi, nó nên hỏi lại tuổi), và mũi tên màu đỏ hiển thị thoát khỏi toàn bộ quá trình do bất kỳ lệnh nào hoặc bất kỳ ý nghĩa hủy bỏ nào khác.<h3 id=trong-thuc-te>Trong thực tế<a title="Permanent link" class=headerlink href=#trong-thuc-te>¶</a></h3><p>Hệ thống Wizard cho phép tương tác nhiều bước với người dùng trong các bot Telegram. Nó hướng dẫn người dùng qua một chuỗi các bước, xác thực đầu vào, lưu trạng thái và chuyển tiếp giữa các bước.<p><strong>Lợi ích chính:</strong> - <strong>An toàn kiểu</strong>: Kiểm tra kiểu tại thời gian biên dịch cho truy cập trạng thái - <strong>Khai báo</strong>: Định nghĩa các bước dưới dạng lớp/nhóm lồng nhau - <strong>Linh hoạt</strong>: Hỗ trợ chuyển tiếp có điều kiện, nhảy và thử lại - <strong>Có trạng thái</strong>: Tự động lưu trữ trạng thái với backend lưu trữ có thể cắm được - <strong>Tích hợp</strong>: Hoạt động với hệ thống Activity hiện có<h3 id=cac-khai-niem-cot-loi>Các Khái Niệm Cốt Lõi<a title="Permanent link" class=headerlink href=#cac-khai-niem-cot-loi>¶</a></h3><h4 id=wizardstep>WizardStep<a title="Permanent link" class=headerlink href=#wizardstep>¶</a></h4><p><code>WizardStep</code> đại diện cho một bước đơn trong luồng wizard. Mỗi bước phải triển khai:<ul><li><strong><code>onEntry(ctx: WizardContext)</code></strong>: Được gọi khi người dùng vào bước này. Sử dụng để nhắc người dùng.<li><strong><code>onRetry(ctx: WizardContext)</code></strong>: Được gọi khi xác thực thất bại và bước nên thử lại. Sử dụng để hiển thị thông báo lỗi.<li><strong><code>validate(ctx: WizardContext): Transition</code></strong>: Xác thực đầu vào hiện tại và trả về <code>Transition</code> chỉ ra điều gì xảy ra tiếp theo.<li><strong><code>store(ctx: WizardContext): Any?</code></strong> (tùy chọn): Trả về giá trị để lưu trữ cho bước này. Trả về <code>null</code> nếu bước không lưu trữ trạng thái.</ul><div class=highlight><pre><span></span><code><a href=#__codelineno-0-1 id=__codelineno-0-1 name=__codelineno-0-1></a><span class=kd>object</span><span class=w> </span><span class=nc>NameStep</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=p>(</span><span class=n>isInitial</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-0-2 id=__codelineno-0-2 name=__codelineno-0-2></a><span class=w>    </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>onEntry</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-0-3 id=__codelineno-0-3 name=__codelineno-0-3></a><span class=w>        </span><span class=n>message</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>"What is your name?"</span><span class=w> </span><span class=p>}.</span><span class=na>send</span><span class=p>(</span><span class=n>ctx</span><span class=p>.</span><span class=na>user</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>bot</span><span class=p>)</span>
<a href=#__codelineno-0-4 id=__codelineno-0-4 name=__codelineno-0-4></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-0-5 id=__codelineno-0-5 name=__codelineno-0-5></a>
<a href=#__codelineno-0-6 id=__codelineno-0-6 name=__codelineno-0-6></a><span class=w>    </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>onRetry</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-0-7 id=__codelineno-0-7 name=__codelineno-0-7></a><span class=w>        </span><span class=n>message</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>"Name cannot be empty. Please try again."</span><span class=w> </span><span class=p>}.</span><span class=na>send</span><span class=p>(</span><span class=n>ctx</span><span class=p>.</span><span class=na>user</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>bot</span><span class=p>)</span>
<a href=#__codelineno-0-8 id=__codelineno-0-8 name=__codelineno-0-8></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-0-9 id=__codelineno-0-9 name=__codelineno-0-9></a>
<a href=#__codelineno-0-10 id=__codelineno-0-10 name=__codelineno-0-10></a><span class=w>    </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>validate</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>):</span><span class=w> </span><span class=n>Transition</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-0-11 id=__codelineno-0-11 name=__codelineno-0-11></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ctx</span><span class=p>.</span><span class=na>update</span><span class=p>.</span><span class=na>text</span><span class=p>.</span><span class=na>isNullOrBlank</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-0-12 id=__codelineno-0-12 name=__codelineno-0-12></a><span class=w>            </span><span class=n>Transition</span><span class=p>.</span><span class=na>Retry</span>
<a href=#__codelineno-0-13 id=__codelineno-0-13 name=__codelineno-0-13></a><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-0-14 id=__codelineno-0-14 name=__codelineno-0-14></a><span class=w>            </span><span class=n>Transition</span><span class=p>.</span><span class=na>Next</span>
<a href=#__codelineno-0-15 id=__codelineno-0-15 name=__codelineno-0-15></a><span class=w>        </span><span class=p>}</span>
<a href=#__codelineno-0-16 id=__codelineno-0-16 name=__codelineno-0-16></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-0-17 id=__codelineno-0-17 name=__codelineno-0-17></a>
<a href=#__codelineno-0-18 id=__codelineno-0-18 name=__codelineno-0-18></a><span class=w>    </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>store</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>):</span><span class=w> </span><span class=kt>String</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-0-19 id=__codelineno-0-19 name=__codelineno-0-19></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>update</span><span class=p>.</span><span class=na>text</span><span class=o>!!</span>
<a href=#__codelineno-0-20 id=__codelineno-0-20 name=__codelineno-0-20></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-0-21 id=__codelineno-0-21 name=__codelineno-0-21></a><span class=p>}</span>
</code></pre></div><div class="admonition note"><p class=admonition-title>Note<p>Nếu một số bước không được đánh dấu là ban đầu -> bước được khai báo đầu tiên được coi là.</div><h4 id=transition>Transition<a title="Permanent link" class=headerlink href=#transition>¶</a></h4><p><code>Transition</code> xác định điều gì xảy ra sau khi xác thực:<ul><li><strong><code>Transition.Next</code></strong>: Chuyển sang bước tiếp theo trong chuỗi<li><strong><code>Transition.JumpTo(step: KClass&lt;out WizardStep>)</code></strong>: Nhảy đến một bước cụ thể<li><strong><code>Transition.Retry</code></strong>: Thử lại bước hiện tại (xác thực thất bại)<li><strong><code>Transition.Finish</code></strong>: Kết thúc wizard</ul><div class=highlight><pre><span></span><code><a href=#__codelineno-1-1 id=__codelineno-1-1 name=__codelineno-1-1></a><span class=c1>// Nhảy có điều kiện dựa trên đầu vào</span>
<a href=#__codelineno-1-2 id=__codelineno-1-2 name=__codelineno-1-2></a><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>validate</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>):</span><span class=w> </span><span class=n>Transition</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-1-3 id=__codelineno-1-3 name=__codelineno-1-3></a><span class=w>    </span><span class=kd>val</span><span class=w> </span><span class=nv>age</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>update</span><span class=p>.</span><span class=na>text</span><span class=o>?.</span><span class=na>toIntOrNull</span><span class=p>()</span>
<a href=#__codelineno-1-4 id=__codelineno-1-4 name=__codelineno-1-4></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>when</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-1-5 id=__codelineno-1-5 name=__codelineno-1-5></a><span class=w>        </span><span class=n>age</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>-></span><span class=w> </span><span class=n>Transition</span><span class=p>.</span><span class=na>Retry</span>
<a href=#__codelineno-1-6 id=__codelineno-1-6 name=__codelineno-1-6></a><span class=w>        </span><span class=n>age</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=m>18</span><span class=w> </span><span class=o>-></span><span class=w> </span><span class=n>Transition</span><span class=p>.</span><span class=na>JumpTo</span><span class=p>(</span><span class=n>UnderageStep</span><span class=o>::</span><span class=n>class</span><span class=p>)</span>
<a href=#__codelineno-1-7 id=__codelineno-1-7 name=__codelineno-1-7></a><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=o>-></span><span class=w> </span><span class=n>Transition</span><span class=p>.</span><span class=na>Next</span>
<a href=#__codelineno-1-8 id=__codelineno-1-8 name=__codelineno-1-8></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-1-9 id=__codelineno-1-9 name=__codelineno-1-9></a><span class=p>}</span>
</code></pre></div><h4 id=wizardcontext>WizardContext<a title="Permanent link" class=headerlink href=#wizardcontext>¶</a></h4><p><code>WizardContext</code> cung cấp quyền truy cập vào: - <strong><code>user: User</code></strong>: Người dùng hiện tại - <strong><code>update: ProcessedUpdate</code></strong>: Cập nhật hiện tại - <strong><code>bot: TelegramBot</code></strong>: Thể hiện bot - <strong><code>userReference: UserChatReference</code></strong>: Tham chiếu ID người dùng và chat cho lưu trữ trạng thái<p>Cộng với các phương thức truy cập trạng thái an toàn kiểu (được tạo bởi KSP).<hr><h3 id=inh-nghia-mot-wizard>Định Nghĩa Một Wizard<a title="Permanent link" class=headerlink href=#inh-nghia-mot-wizard>¶</a></h3><h4 id=cau-truc-co-ban>Cấu Trúc Cơ Bản<a title="Permanent link" class=headerlink href=#cau-truc-co-ban>¶</a></h4><p>Một wizard được định nghĩa là một lớp hoặc đối tượng được chú thích với <code>@WizardHandler</code>:<div class=highlight><pre><span></span><code><a href=#__codelineno-2-1 id=__codelineno-2-1 name=__codelineno-2-1></a><span class=nd>@WizardHandler</span><span class=p>(</span><span class=n>trigger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>[</span><span class=s>"/survey"</span><span class=o>]</span><span class=p>)</span>
<a href=#__codelineno-2-2 id=__codelineno-2-2 name=__codelineno-2-2></a><span class=kd>object</span><span class=w> </span><span class=nc>SurveyWizard</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-2-3 id=__codelineno-2-3 name=__codelineno-2-3></a><span class=w>    </span><span class=kd>object</span><span class=w> </span><span class=nc>NameStep</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=p>(</span><span class=n>isInitial</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-2-4 id=__codelineno-2-4 name=__codelineno-2-4></a><span class=w>        </span><span class=c1>// ... triển khai bước</span>
<a href=#__codelineno-2-5 id=__codelineno-2-5 name=__codelineno-2-5></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-2-6 id=__codelineno-2-6 name=__codelineno-2-6></a>
<a href=#__codelineno-2-7 id=__codelineno-2-7 name=__codelineno-2-7></a><span class=w>    </span><span class=kd>object</span><span class=w> </span><span class=nc>AgeStep</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-2-8 id=__codelineno-2-8 name=__codelineno-2-8></a><span class=w>        </span><span class=c1>// ... triển khai bước</span>
<a href=#__codelineno-2-9 id=__codelineno-2-9 name=__codelineno-2-9></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-2-10 id=__codelineno-2-10 name=__codelineno-2-10></a>
<a href=#__codelineno-2-11 id=__codelineno-2-11 name=__codelineno-2-11></a><span class=w>    </span><span class=kd>object</span><span class=w> </span><span class=nc>FinishStep</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-2-12 id=__codelineno-2-12 name=__codelineno-2-12></a><span class=w>        </span><span class=c1>// ... triển khai bước</span>
<a href=#__codelineno-2-13 id=__codelineno-2-13 name=__codelineno-2-13></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-2-14 id=__codelineno-2-14 name=__codelineno-2-14></a><span class=p>}</span>
</code></pre></div><h4 id=tham-so-chu-thich>Tham Số Chú Thích<a title="Permanent link" class=headerlink href=#tham-so-chu-thich>¶</a></h4><p><strong><code>@WizardHandler</code></strong> chấp nhận: - <strong><code>trigger: Array&lt;String></code></strong>: Lệnh bắt đầu wizard (ví dụ: <code>["/start", "/survey"]</code>) - <strong><code>scope: Array&lt;UpdateType></code></strong>: Các loại cập nhật để lắng nghe (mặc định: <code>[UpdateType.MESSAGE]</code>) - <strong><code>stateManagers: Array&lt;KClass&lt;out WizardStateManager&lt;*>>></code></strong>: Các lớp quản lý trạng thái cho lưu trữ dữ liệu bước<hr><h3 id=quan-ly-trang-thai>Quản Lý Trạng Thái<a title="Permanent link" class=headerlink href=#quan-ly-trang-thai>¶</a></h3><h4 id=wizardstatemanager>WizardStateManager<a title="Permanent link" class=headerlink href=#wizardstatemanager>¶</a></h4><p>Trạng thái được lưu trữ sử dụng các triển khai <code>WizardStateManager&lt;T></code>. Mỗi trình quản lý xử lý một kiểu cụ thể:<div class=highlight><pre><span></span><code><a href=#__codelineno-3-1 id=__codelineno-3-1 name=__codelineno-3-1></a><span class=kd>interface</span><span class=w> </span><span class=nc>WizardStateManager</span><span class=o>&lt;</span><span class=n>T</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kt>Any</span><span class=o>></span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-3-2 id=__codelineno-3-2 name=__codelineno-3-2></a><span class=w>    </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=n>key</span><span class=p>:</span><span class=w> </span><span class=n>KClass</span><span class=o>&lt;</span><span class=k>out</span><span class=w> </span><span class=n>WizardStep</span><span class=o>></span><span class=p>,</span><span class=w> </span><span class=n>reference</span><span class=p>:</span><span class=w> </span><span class=n>UserChatReference</span><span class=p>):</span><span class=w> </span><span class=n>T?</span>
<a href=#__codelineno-3-3 id=__codelineno-3-3 name=__codelineno-3-3></a><span class=w>    </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>set</span><span class=p>(</span><span class=n>key</span><span class=p>:</span><span class=w> </span><span class=n>KClass</span><span class=o>&lt;</span><span class=k>out</span><span class=w> </span><span class=n>WizardStep</span><span class=o>></span><span class=p>,</span><span class=w> </span><span class=n>reference</span><span class=p>:</span><span class=w> </span><span class=n>UserChatReference</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>:</span><span class=w> </span><span class=n>T</span><span class=p>)</span>
<a href=#__codelineno-3-4 id=__codelineno-3-4 name=__codelineno-3-4></a><span class=w>    </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>del</span><span class=p>(</span><span class=n>key</span><span class=p>:</span><span class=w> </span><span class=n>KClass</span><span class=o>&lt;</span><span class=k>out</span><span class=w> </span><span class=n>WizardStep</span><span class=o>></span><span class=p>,</span><span class=w> </span><span class=n>reference</span><span class=p>:</span><span class=w> </span><span class=n>UserChatReference</span><span class=p>)</span>
<a href=#__codelineno-3-5 id=__codelineno-3-5 name=__codelineno-3-5></a><span class=p>}</span>
</code></pre></div><p>Xem thêm: <a href=https://vendelieu.github.io/telegram-bot/telegram-bot/eu.vendeli.tgbot.implementations/-map-state-manager/index.html>MapStateManager<t>, <a href=https://vendelieu.github.io/telegram-bot/telegram-bot/eu.vendeli.tgbot.implementations/-map-string-state-manager/index.html>MapStringStateManager</a>, <a href=https://vendelieu.github.io/telegram-bot/telegram-bot/eu.vendeli.tgbot.implementations/-map-int-state-manager/index.html>MapIntStateManager</a>, <a href=https://vendelieu.github.io/telegram-bot/telegram-bot/eu.vendeli.tgbot.implementations/-map-long-state-manager/index.html>MapLongStateManager</a>. <h4 id=ghep-oi-tu-ong>Ghép Đôi Tự Động<a title="Permanent link" class=headerlink href=#ghep-oi-tu-ong>¶</a></h4> <p>KSP ghép các bước với trình quản lý trạng thái dựa trên kiểu trả về của <code>store()</code>:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-4-1 id=__codelineno-4-1 name=__codelineno-4-1></a><span class=nd>@WizardHandler</span><span class=p>(</span>
<a href=#__codelineno-4-2 id=__codelineno-4-2 name=__codelineno-4-2></a><span class=w>    </span><span class=n>trigger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>[</span><span class=s>"/survey"</span><span class=o>]</span><span class=p>,</span>
<a href=#__codelineno-4-3 id=__codelineno-4-3 name=__codelineno-4-3></a><span class=w>    </span><span class=n>stateManagers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>[</span><span class=n>StringStateManager</span><span class=o>::</span><span class=n>class</span><span class=p>,</span><span class=w> </span><span class=n>IntStateManager</span><span class=o>::</span><span class=n>class</span><span class=o>]</span>
<a href=#__codelineno-4-4 id=__codelineno-4-4 name=__codelineno-4-4></a><span class=p>)</span>
<a href=#__codelineno-4-5 id=__codelineno-4-5 name=__codelineno-4-5></a><span class=kd>object</span><span class=w> </span><span class=nc>SurveyWizard</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-4-6 id=__codelineno-4-6 name=__codelineno-4-6></a><span class=w>    </span><span class=kd>object</span><span class=w> </span><span class=nc>NameStep</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=p>(</span><span class=n>isInitial</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-4-7 id=__codelineno-4-7 name=__codelineno-4-7></a><span class=w>        </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>store</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>):</span><span class=w> </span><span class=kt>String</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-4-8 id=__codelineno-4-8 name=__codelineno-4-8></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>update</span><span class=p>.</span><span class=na>text</span><span class=o>!!</span><span class=w> </span><span class=c1>// Khớp với StringStateManager</span>
<a href=#__codelineno-4-9 id=__codelineno-4-9 name=__codelineno-4-9></a><span class=w>        </span><span class=p>}</span>
<a href=#__codelineno-4-10 id=__codelineno-4-10 name=__codelineno-4-10></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-4-11 id=__codelineno-4-11 name=__codelineno-4-11></a>
<a href=#__codelineno-4-12 id=__codelineno-4-12 name=__codelineno-4-12></a><span class=w>    </span><span class=kd>object</span><span class=w> </span><span class=nc>AgeStep</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-4-13 id=__codelineno-4-13 name=__codelineno-4-13></a><span class=w>        </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>store</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>):</span><span class=w> </span><span class=kt>Int</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-4-14 id=__codelineno-4-14 name=__codelineno-4-14></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>update</span><span class=p>.</span><span class=na>text</span><span class=o>!!</span><span class=p>.</span><span class=na>toInt</span><span class=p>()</span><span class=w> </span><span class=c1>// Khớp với IntStateManager</span>
<a href=#__codelineno-4-15 id=__codelineno-4-15 name=__codelineno-4-15></a><span class=w>        </span><span class=p>}</span>
<a href=#__codelineno-4-16 id=__codelineno-4-16 name=__codelineno-4-16></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-4-17 id=__codelineno-4-17 name=__codelineno-4-17></a><span class=p>}</span>
</code></pre></div> <h4 id=ghi-e-theo-buoc>Ghi Đè Theo Bước<a title="Permanent link" class=headerlink href=#ghi-e-theo-buoc>¶</a></h4> <p>Ghi đè trình quản lý trạng thái cho một bước cụ thể sử dụng <code>@WizardHandler.StateManager</code>:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-5-1 id=__codelineno-5-1 name=__codelineno-5-1></a><span class=nd>@WizardHandler</span><span class=p>(</span>
<a href=#__codelineno-5-2 id=__codelineno-5-2 name=__codelineno-5-2></a><span class=w>    </span><span class=n>trigger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>[</span><span class=s>"/survey"</span><span class=o>]</span><span class=p>,</span>
<a href=#__codelineno-5-3 id=__codelineno-5-3 name=__codelineno-5-3></a><span class=w>    </span><span class=n>stateManagers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>[</span><span class=n>DefaultStateManager</span><span class=o>::</span><span class=n>class</span><span class=o>]</span>
<a href=#__codelineno-5-4 id=__codelineno-5-4 name=__codelineno-5-4></a><span class=p>)</span>
<a href=#__codelineno-5-5 id=__codelineno-5-5 name=__codelineno-5-5></a><span class=kd>object</span><span class=w> </span><span class=nc>SurveyWizard</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-5-6 id=__codelineno-5-6 name=__codelineno-5-6></a><span class=w>    </span><span class=kd>object</span><span class=w> </span><span class=nc>NameStep</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=p>(</span><span class=n>isInitial</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-5-7 id=__codelineno-5-7 name=__codelineno-5-7></a><span class=w>        </span><span class=c1>// Sử dụng DefaultStateManager</span>
<a href=#__codelineno-5-8 id=__codelineno-5-8 name=__codelineno-5-8></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-5-9 id=__codelineno-5-9 name=__codelineno-5-9></a>
<a href=#__codelineno-5-10 id=__codelineno-5-10 name=__codelineno-5-10></a><span class=w>    </span><span class=nd>@WizardHandler.StateManager</span><span class=p>(</span><span class=n>CustomStateManager</span><span class=o>::</span><span class=n>class</span><span class=p>)</span>
<a href=#__codelineno-5-11 id=__codelineno-5-11 name=__codelineno-5-11></a><span class=w>    </span><span class=kd>object</span><span class=w> </span><span class=nc>AgeStep</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-5-12 id=__codelineno-5-12 name=__codelineno-5-12></a><span class=w>        </span><span class=c1>// Sử dụng CustomStateManager thay thế</span>
<a href=#__codelineno-5-13 id=__codelineno-5-13 name=__codelineno-5-13></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-5-14 id=__codelineno-5-14 name=__codelineno-5-14></a><span class=p>}</span>
</code></pre></div> <hr> <h3 id=truy-cap-trang-thai-an-toan-kieu>Truy Cập Trạng Thái An Toàn Kiểu<a title="Permanent link" class=headerlink href=#truy-cap-trang-thai-an-toan-kieu>¶</a></h3> <p>KSP tạo các hàm mở rộng an toàn kiểu trên <code>WizardContext</code> cho mỗi bước lưu trữ trạng thái.</p> <h4 id=ham-uoc-tao>Hàm Được Tạo<a title="Permanent link" class=headerlink href=#ham-uoc-tao>¶</a></h4> <p>Đối với một bước lưu trữ <code>String</code>:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-6-1 id=__codelineno-6-1 name=__codelineno-6-1></a><span class=c1>// Được tạo tự động bởi KSP</span>
<a href=#__codelineno-6-2 id=__codelineno-6-2 name=__codelineno-6-2></a><span class=kd>suspend</span><span class=w> </span><span class=kd>inline</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=o>&lt;</span><span class=k>reified</span><span class=w> </span><span class=n>S</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=o>></span><span class=w> </span><span class=n>WizardContext</span><span class=p>.</span><span class=nf>getState</span><span class=p>():</span><span class=w> </span><span class=kt>String?</span>
<a href=#__codelineno-6-3 id=__codelineno-6-3 name=__codelineno-6-3></a><span class=kd>suspend</span><span class=w> </span><span class=kd>inline</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=o>&lt;</span><span class=k>reified</span><span class=w> </span><span class=n>S</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=o>></span><span class=w> </span><span class=n>WizardContext</span><span class=p>.</span><span class=nf>setState</span><span class=p>(</span><span class=n>value</span><span class=p>:</span><span class=w> </span><span class=kt>String</span><span class=p>)</span>
<a href=#__codelineno-6-4 id=__codelineno-6-4 name=__codelineno-6-4></a><span class=kd>suspend</span><span class=w> </span><span class=kd>inline</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=o>&lt;</span><span class=k>reified</span><span class=w> </span><span class=n>S</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=o>></span><span class=w> </span><span class=n>WizardContext</span><span class=p>.</span><span class=nf>delState</span><span class=p>()</span>
</code></pre></div> <h4 id=cach-su-dung>Cách Sử Dụng<a title="Permanent link" class=headerlink href=#cach-su-dung>¶</a></h4> <div class=highlight><pre><span></span><code><a href=#__codelineno-7-1 id=__codelineno-7-1 name=__codelineno-7-1></a><span class=kd>object</span><span class=w> </span><span class=nc>FinishStep</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-7-2 id=__codelineno-7-2 name=__codelineno-7-2></a><span class=w>    </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>onEntry</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-7-3 id=__codelineno-7-3 name=__codelineno-7-3></a><span class=w>        </span><span class=c1>// Truy cập an toàn kiểu - trả về String? (nullable)</span>
<a href=#__codelineno-7-4 id=__codelineno-7-4 name=__codelineno-7-4></a><span class=w>        </span><span class=kd>val</span><span class=w> </span><span class=nv>name</span><span class=p>:</span><span class=w> </span><span class=kt>String?</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>getState</span><span class=o>&lt;</span><span class=n>NameStep</span><span class=o>></span><span class=p>()</span>
<a href=#__codelineno-7-5 id=__codelineno-7-5 name=__codelineno-7-5></a>
<a href=#__codelineno-7-6 id=__codelineno-7-6 name=__codelineno-7-6></a><span class=w>        </span><span class=c1>// Truy cập an toàn kiểu - trả về Int? (nullable)</span>
<a href=#__codelineno-7-7 id=__codelineno-7-7 name=__codelineno-7-7></a><span class=w>        </span><span class=kd>val</span><span class=w> </span><span class=nv>age</span><span class=p>:</span><span class=w> </span><span class=kt>Int?</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>getState</span><span class=o>&lt;</span><span class=n>AgeStep</span><span class=o>></span><span class=p>()</span>
<a href=#__codelineno-7-8 id=__codelineno-7-8 name=__codelineno-7-8></a>
<a href=#__codelineno-7-9 id=__codelineno-7-9 name=__codelineno-7-9></a><span class=w>        </span><span class=kd>val</span><span class=w> </span><span class=nv>summary</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buildString</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-7-10 id=__codelineno-7-10 name=__codelineno-7-10></a><span class=w>            </span><span class=n>appendLine</span><span class=p>(</span><span class=s>"Name: </span><span class=si>$</span><span class=n>name</span><span class=s>"</span><span class=p>)</span>
<a href=#__codelineno-7-11 id=__codelineno-7-11 name=__codelineno-7-11></a><span class=w>            </span><span class=n>appendLine</span><span class=p>(</span><span class=s>"Age: </span><span class=si>$</span><span class=n>age</span><span class=s>"</span><span class=p>)</span>
<a href=#__codelineno-7-12 id=__codelineno-7-12 name=__codelineno-7-12></a><span class=w>        </span><span class=p>}</span>
<a href=#__codelineno-7-13 id=__codelineno-7-13 name=__codelineno-7-13></a>
<a href=#__codelineno-7-14 id=__codelineno-7-14 name=__codelineno-7-14></a><span class=w>        </span><span class=n>message</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>summary</span><span class=w> </span><span class=p>}.</span><span class=na>send</span><span class=p>(</span><span class=n>ctx</span><span class=p>.</span><span class=na>user</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>bot</span><span class=p>)</span>
<a href=#__codelineno-7-15 id=__codelineno-7-15 name=__codelineno-7-15></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-7-16 id=__codelineno-7-16 name=__codelineno-7-16></a>
<a href=#__codelineno-7-17 id=__codelineno-7-17 name=__codelineno-7-17></a><span class=w>    </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>onRetry</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>Unit</span>
<a href=#__codelineno-7-18 id=__codelineno-7-18 name=__codelineno-7-18></a>
<a href=#__codelineno-7-19 id=__codelineno-7-19 name=__codelineno-7-19></a><span class=w>    </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>validate</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>):</span><span class=w> </span><span class=n>Transition</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-7-20 id=__codelineno-7-20 name=__codelineno-7-20></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Transition</span><span class=p>.</span><span class=na>Finish</span>
<a href=#__codelineno-7-21 id=__codelineno-7-21 name=__codelineno-7-21></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-7-22 id=__codelineno-7-22 name=__codelineno-7-22></a><span class=p>}</span>
</code></pre></div> <h4 id=phuong-thuc-du-phong>Phương Thức Dự Phòng<a title="Permanent link" class=headerlink href=#phuong-thuc-du-phong>¶</a></h4> <p>Nếu các phương thức an toàn kiểu không khả dụng, sử dụng các phương thức dự phòng:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-8-1 id=__codelineno-8-1 name=__codelineno-8-1></a><span class=c1>// Dự phòng - trả về Any?</span>
<a href=#__codelineno-8-2 id=__codelineno-8-2 name=__codelineno-8-2></a><span class=kd>val</span><span class=w> </span><span class=nv>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>getState</span><span class=p>(</span><span class=n>NameStep</span><span class=o>::</span><span class=n>class</span><span class=p>)</span>
<a href=#__codelineno-8-3 id=__codelineno-8-3 name=__codelineno-8-3></a>
<a href=#__codelineno-8-4 id=__codelineno-8-4 name=__codelineno-8-4></a><span class=c1>// Dự phòng - chấp nhận Any?</span>
<a href=#__codelineno-8-5 id=__codelineno-8-5 name=__codelineno-8-5></a><span class=n>ctx</span><span class=p>.</span><span class=na>setState</span><span class=p>(</span><span class=n>NameStep</span><span class=o>::</span><span class=n>class</span><span class=p>,</span><span class=w> </span><span class=s>"John"</span><span class=p>)</span>
<a href=#__codelineno-8-6 id=__codelineno-8-6 name=__codelineno-8-6></a><span class=n>ctx</span><span class=p>.</span><span class=na>delState</span><span class=p>(</span><span class=n>NameStep</span><span class=o>::</span><span class=n>class</span><span class=p>)</span>
</code></pre></div> <hr> <h3 id=vi-du-hoan-chinh>Ví Dụ Hoàn Chỉnh<a title="Permanent link" class=headerlink href=#vi-du-hoan-chinh>¶</a></h3> <h4 id=wizard-ang-ky-nguoi-dung>Wizard Đăng Ký Người Dùng<a title="Permanent link" class=headerlink href=#wizard-ang-ky-nguoi-dung>¶</a></h4> <div class=highlight><pre><span></span><code><a href=#__codelineno-9-1 id=__codelineno-9-1 name=__codelineno-9-1></a><span class=nd>@WizardHandler</span><span class=p>(</span>
<a href=#__codelineno-9-2 id=__codelineno-9-2 name=__codelineno-9-2></a><span class=w>    </span><span class=n>trigger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>[</span><span class=s>"/register"</span><span class=o>]</span><span class=p>,</span>
<a href=#__codelineno-9-3 id=__codelineno-9-3 name=__codelineno-9-3></a><span class=w>    </span><span class=n>stateManagers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>[</span><span class=n>StringStateManager</span><span class=o>::</span><span class=n>class</span><span class=p>,</span><span class=w> </span><span class=n>IntStateManager</span><span class=o>::</span><span class=n>class</span><span class=o>]</span>
<a href=#__codelineno-9-4 id=__codelineno-9-4 name=__codelineno-9-4></a><span class=p>)</span>
<a href=#__codelineno-9-5 id=__codelineno-9-5 name=__codelineno-9-5></a><span class=kd>object</span><span class=w> </span><span class=nc>RegistrationWizard</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-6 id=__codelineno-9-6 name=__codelineno-9-6></a><span class=w>    </span><span class=kd>object</span><span class=w> </span><span class=nc>NameStep</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=p>(</span><span class=n>isInitial</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-7 id=__codelineno-9-7 name=__codelineno-9-7></a><span class=w>        </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>onEntry</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-8 id=__codelineno-9-8 name=__codelineno-9-8></a><span class=w>            </span><span class=n>message</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>"What is your name?"</span><span class=w> </span><span class=p>}.</span><span class=na>send</span><span class=p>(</span><span class=n>ctx</span><span class=p>.</span><span class=na>user</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>bot</span><span class=p>)</span>
<a href=#__codelineno-9-9 id=__codelineno-9-9 name=__codelineno-9-9></a><span class=w>        </span><span class=p>}</span>
<a href=#__codelineno-9-10 id=__codelineno-9-10 name=__codelineno-9-10></a>
<a href=#__codelineno-9-11 id=__codelineno-9-11 name=__codelineno-9-11></a><span class=w>        </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>onRetry</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-12 id=__codelineno-9-12 name=__codelineno-9-12></a><span class=w>            </span><span class=n>message</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>"Please enter a valid name."</span><span class=w> </span><span class=p>}.</span><span class=na>send</span><span class=p>(</span><span class=n>ctx</span><span class=p>.</span><span class=na>user</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>bot</span><span class=p>)</span>
<a href=#__codelineno-9-13 id=__codelineno-9-13 name=__codelineno-9-13></a><span class=w>        </span><span class=p>}</span>
<a href=#__codelineno-9-14 id=__codelineno-9-14 name=__codelineno-9-14></a>
<a href=#__codelineno-9-15 id=__codelineno-9-15 name=__codelineno-9-15></a><span class=w>        </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>validate</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>):</span><span class=w> </span><span class=n>Transition</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-16 id=__codelineno-9-16 name=__codelineno-9-16></a><span class=w>            </span><span class=kd>val</span><span class=w> </span><span class=nv>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>update</span><span class=p>.</span><span class=na>text</span><span class=o>?.</span><span class=na>trim</span><span class=p>()</span>
<a href=#__codelineno-9-17 id=__codelineno-9-17 name=__codelineno-9-17></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>name</span><span class=p>.</span><span class=na>isNullOrBlank</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>name</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=m>2</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-18 id=__codelineno-9-18 name=__codelineno-9-18></a><span class=w>                </span><span class=n>Transition</span><span class=p>.</span><span class=na>Retry</span>
<a href=#__codelineno-9-19 id=__codelineno-9-19 name=__codelineno-9-19></a><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-20 id=__codelineno-9-20 name=__codelineno-9-20></a><span class=w>                </span><span class=n>Transition</span><span class=p>.</span><span class=na>Next</span>
<a href=#__codelineno-9-21 id=__codelineno-9-21 name=__codelineno-9-21></a><span class=w>            </span><span class=p>}</span>
<a href=#__codelineno-9-22 id=__codelineno-9-22 name=__codelineno-9-22></a><span class=w>        </span><span class=p>}</span>
<a href=#__codelineno-9-23 id=__codelineno-9-23 name=__codelineno-9-23></a>
<a href=#__codelineno-9-24 id=__codelineno-9-24 name=__codelineno-9-24></a><span class=w>        </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>store</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>):</span><span class=w> </span><span class=kt>String</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-25 id=__codelineno-9-25 name=__codelineno-9-25></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>update</span><span class=p>.</span><span class=na>text</span><span class=o>!!</span><span class=p>.</span><span class=na>trim</span><span class=p>()</span>
<a href=#__codelineno-9-26 id=__codelineno-9-26 name=__codelineno-9-26></a><span class=w>        </span><span class=p>}</span>
<a href=#__codelineno-9-27 id=__codelineno-9-27 name=__codelineno-9-27></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-9-28 id=__codelineno-9-28 name=__codelineno-9-28></a>
<a href=#__codelineno-9-29 id=__codelineno-9-29 name=__codelineno-9-29></a><span class=w>    </span><span class=kd>object</span><span class=w> </span><span class=nc>AgeStep</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-30 id=__codelineno-9-30 name=__codelineno-9-30></a><span class=w>        </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>onEntry</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-31 id=__codelineno-9-31 name=__codelineno-9-31></a><span class=w>            </span><span class=n>message</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>"How old are you?"</span><span class=w> </span><span class=p>}.</span><span class=na>send</span><span class=p>(</span><span class=n>ctx</span><span class=p>.</span><span class=na>user</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>bot</span><span class=p>)</span>
<a href=#__codelineno-9-32 id=__codelineno-9-32 name=__codelineno-9-32></a><span class=w>        </span><span class=p>}</span>
<a href=#__codelineno-9-33 id=__codelineno-9-33 name=__codelineno-9-33></a>
<a href=#__codelineno-9-34 id=__codelineno-9-34 name=__codelineno-9-34></a><span class=w>        </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>onRetry</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-35 id=__codelineno-9-35 name=__codelineno-9-35></a><span class=w>            </span><span class=n>message</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>"Please enter a valid age (must be a number)."</span><span class=w> </span><span class=p>}.</span><span class=na>send</span><span class=p>(</span><span class=n>ctx</span><span class=p>.</span><span class=na>user</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>bot</span><span class=p>)</span>
<a href=#__codelineno-9-36 id=__codelineno-9-36 name=__codelineno-9-36></a><span class=w>        </span><span class=p>}</span>
<a href=#__codelineno-9-37 id=__codelineno-9-37 name=__codelineno-9-37></a>
<a href=#__codelineno-9-38 id=__codelineno-9-38 name=__codelineno-9-38></a><span class=w>        </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>validate</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>):</span><span class=w> </span><span class=n>Transition</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-39 id=__codelineno-9-39 name=__codelineno-9-39></a><span class=w>            </span><span class=kd>val</span><span class=w> </span><span class=nv>age</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>update</span><span class=p>.</span><span class=na>text</span><span class=o>?.</span><span class=na>toIntOrNull</span><span class=p>()</span>
<a href=#__codelineno-9-40 id=__codelineno-9-40 name=__codelineno-9-40></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>when</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-41 id=__codelineno-9-41 name=__codelineno-9-41></a><span class=w>                </span><span class=n>age</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>-></span><span class=w> </span><span class=n>Transition</span><span class=p>.</span><span class=na>Retry</span>
<a href=#__codelineno-9-42 id=__codelineno-9-42 name=__codelineno-9-42></a><span class=w>                </span><span class=n>age</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=m>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>age</span><span class=w> </span><span class=o>></span><span class=w> </span><span class=m>150</span><span class=w> </span><span class=o>-></span><span class=w> </span><span class=n>Transition</span><span class=p>.</span><span class=na>Retry</span>
<a href=#__codelineno-9-43 id=__codelineno-9-43 name=__codelineno-9-43></a><span class=w>                </span><span class=n>age</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=m>18</span><span class=w> </span><span class=o>-></span><span class=w> </span><span class=n>Transition</span><span class=p>.</span><span class=na>JumpTo</span><span class=p>(</span><span class=n>UnderageStep</span><span class=o>::</span><span class=n>class</span><span class=p>)</span>
<a href=#__codelineno-9-44 id=__codelineno-9-44 name=__codelineno-9-44></a><span class=w>                </span><span class=k>else</span><span class=w> </span><span class=o>-></span><span class=w> </span><span class=n>Transition</span><span class=p>.</span><span class=na>Next</span>
<a href=#__codelineno-9-45 id=__codelineno-9-45 name=__codelineno-9-45></a><span class=w>            </span><span class=p>}</span>
<a href=#__codelineno-9-46 id=__codelineno-9-46 name=__codelineno-9-46></a><span class=w>        </span><span class=p>}</span>
<a href=#__codelineno-9-47 id=__codelineno-9-47 name=__codelineno-9-47></a>
<a href=#__codelineno-9-48 id=__codelineno-9-48 name=__codelineno-9-48></a><span class=w>        </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>store</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>):</span><span class=w> </span><span class=kt>Int</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-49 id=__codelineno-9-49 name=__codelineno-9-49></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>update</span><span class=p>.</span><span class=na>text</span><span class=o>!!</span><span class=p>.</span><span class=na>toInt</span><span class=p>()</span>
<a href=#__codelineno-9-50 id=__codelineno-9-50 name=__codelineno-9-50></a><span class=w>        </span><span class=p>}</span>
<a href=#__codelineno-9-51 id=__codelineno-9-51 name=__codelineno-9-51></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-9-52 id=__codelineno-9-52 name=__codelineno-9-52></a>
<a href=#__codelineno-9-53 id=__codelineno-9-53 name=__codelineno-9-53></a><span class=w>    </span><span class=kd>object</span><span class=w> </span><span class=nc>UnderageStep</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-54 id=__codelineno-9-54 name=__codelineno-9-54></a><span class=w>        </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>onEntry</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-55 id=__codelineno-9-55 name=__codelineno-9-55></a><span class=w>            </span><span class=n>message</span><span class=w> </span><span class=p>{</span><span class=w> </span>
<a href=#__codelineno-9-56 id=__codelineno-9-56 name=__codelineno-9-56></a><span class=w>                </span><span class=s>"Sorry, you must be 18 or older to register."</span><span class=w> </span>
<a href=#__codelineno-9-57 id=__codelineno-9-57 name=__codelineno-9-57></a><span class=w>            </span><span class=p>}.</span><span class=na>send</span><span class=p>(</span><span class=n>ctx</span><span class=p>.</span><span class=na>user</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>bot</span><span class=p>)</span>
<a href=#__codelineno-9-58 id=__codelineno-9-58 name=__codelineno-9-58></a><span class=w>        </span><span class=p>}</span>
<a href=#__codelineno-9-59 id=__codelineno-9-59 name=__codelineno-9-59></a>
<a href=#__codelineno-9-60 id=__codelineno-9-60 name=__codelineno-9-60></a><span class=w>        </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>onRetry</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>Unit</span>
<a href=#__codelineno-9-61 id=__codelineno-9-61 name=__codelineno-9-61></a>
<a href=#__codelineno-9-62 id=__codelineno-9-62 name=__codelineno-9-62></a><span class=w>        </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>validate</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>):</span><span class=w> </span><span class=n>Transition</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-63 id=__codelineno-9-63 name=__codelineno-9-63></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>Transition</span><span class=p>.</span><span class=na>Finish</span>
<a href=#__codelineno-9-64 id=__codelineno-9-64 name=__codelineno-9-64></a><span class=w>        </span><span class=p>}</span>
<a href=#__codelineno-9-65 id=__codelineno-9-65 name=__codelineno-9-65></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-9-66 id=__codelineno-9-66 name=__codelineno-9-66></a>
<a href=#__codelineno-9-67 id=__codelineno-9-67 name=__codelineno-9-67></a><span class=w>    </span><span class=kd>object</span><span class=w> </span><span class=nc>ConfirmationStep</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-68 id=__codelineno-9-68 name=__codelineno-9-68></a><span class=w>        </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>onEntry</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-69 id=__codelineno-9-69 name=__codelineno-9-69></a><span class=w>            </span><span class=c1>// Truy cập trạng thái an toàn kiểu</span>
<a href=#__codelineno-9-70 id=__codelineno-9-70 name=__codelineno-9-70></a><span class=w>            </span><span class=kd>val</span><span class=w> </span><span class=nv>name</span><span class=p>:</span><span class=w> </span><span class=kt>String?</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>getState</span><span class=o>&lt;</span><span class=n>NameStep</span><span class=o>></span><span class=p>()</span>
<a href=#__codelineno-9-71 id=__codelineno-9-71 name=__codelineno-9-71></a><span class=w>            </span><span class=kd>val</span><span class=w> </span><span class=nv>age</span><span class=p>:</span><span class=w> </span><span class=kt>Int?</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>getState</span><span class=o>&lt;</span><span class=n>AgeStep</span><span class=o>></span><span class=p>()</span>
<a href=#__codelineno-9-72 id=__codelineno-9-72 name=__codelineno-9-72></a>
<a href=#__codelineno-9-73 id=__codelineno-9-73 name=__codelineno-9-73></a><span class=w>            </span><span class=kd>val</span><span class=w> </span><span class=nv>confirmation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buildString</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-74 id=__codelineno-9-74 name=__codelineno-9-74></a><span class=w>                </span><span class=n>appendLine</span><span class=p>(</span><span class=s>"Please confirm your information:"</span><span class=p>)</span>
<a href=#__codelineno-9-75 id=__codelineno-9-75 name=__codelineno-9-75></a><span class=w>                </span><span class=n>appendLine</span><span class=p>(</span><span class=s>"Name: </span><span class=si>$</span><span class=n>name</span><span class=s>"</span><span class=p>)</span>
<a href=#__codelineno-9-76 id=__codelineno-9-76 name=__codelineno-9-76></a><span class=w>                </span><span class=n>appendLine</span><span class=p>(</span><span class=s>"Age: </span><span class=si>$</span><span class=n>age</span><span class=s>"</span><span class=p>)</span>
<a href=#__codelineno-9-77 id=__codelineno-9-77 name=__codelineno-9-77></a><span class=w>                </span><span class=n>appendLine</span><span class=p>()</span>
<a href=#__codelineno-9-78 id=__codelineno-9-78 name=__codelineno-9-78></a><span class=w>                </span><span class=n>appendLine</span><span class=p>(</span><span class=s>"Reply 'yes' to confirm or 'no' to start over."</span><span class=p>)</span>
<a href=#__codelineno-9-79 id=__codelineno-9-79 name=__codelineno-9-79></a><span class=w>            </span><span class=p>}</span>
<a href=#__codelineno-9-80 id=__codelineno-9-80 name=__codelineno-9-80></a>
<a href=#__codelineno-9-81 id=__codelineno-9-81 name=__codelineno-9-81></a><span class=w>            </span><span class=n>message</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>confirmation</span><span class=w> </span><span class=p>}.</span><span class=na>send</span><span class=p>(</span><span class=n>ctx</span><span class=p>.</span><span class=na>user</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>bot</span><span class=p>)</span>
<a href=#__codelineno-9-82 id=__codelineno-9-82 name=__codelineno-9-82></a><span class=w>        </span><span class=p>}</span>
<a href=#__codelineno-9-83 id=__codelineno-9-83 name=__codelineno-9-83></a>
<a href=#__codelineno-9-84 id=__codelineno-9-84 name=__codelineno-9-84></a><span class=w>        </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>onRetry</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-85 id=__codelineno-9-85 name=__codelineno-9-85></a><span class=w>            </span><span class=n>message</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>"Please reply 'yes' or 'no'."</span><span class=w> </span><span class=p>}.</span><span class=na>send</span><span class=p>(</span><span class=n>ctx</span><span class=p>.</span><span class=na>user</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>bot</span><span class=p>)</span>
<a href=#__codelineno-9-86 id=__codelineno-9-86 name=__codelineno-9-86></a><span class=w>        </span><span class=p>}</span>
<a href=#__codelineno-9-87 id=__codelineno-9-87 name=__codelineno-9-87></a>
<a href=#__codelineno-9-88 id=__codelineno-9-88 name=__codelineno-9-88></a><span class=w>        </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>validate</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>):</span><span class=w> </span><span class=n>Transition</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-89 id=__codelineno-9-89 name=__codelineno-9-89></a><span class=w>            </span><span class=kd>val</span><span class=w> </span><span class=nv>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>update</span><span class=p>.</span><span class=na>text</span><span class=o>?.</span><span class=na>lowercase</span><span class=p>()</span><span class=o>?.</span><span class=na>trim</span><span class=p>()</span>
<a href=#__codelineno-9-90 id=__codelineno-9-90 name=__codelineno-9-90></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>when</span><span class=w> </span><span class=p>(</span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-91 id=__codelineno-9-91 name=__codelineno-9-91></a><span class=w>                </span><span class=s>"yes"</span><span class=w> </span><span class=o>-></span><span class=w> </span><span class=n>Transition</span><span class=p>.</span><span class=na>Finish</span>
<a href=#__codelineno-9-92 id=__codelineno-9-92 name=__codelineno-9-92></a><span class=w>                </span><span class=s>"no"</span><span class=w> </span><span class=o>-></span><span class=w> </span><span class=n>Transition</span><span class=p>.</span><span class=na>JumpTo</span><span class=p>(</span><span class=n>NameStep</span><span class=o>::</span><span class=n>class</span><span class=p>)</span><span class=w> </span><span class=c1>// Bắt đầu lại</span>
<a href=#__codelineno-9-93 id=__codelineno-9-93 name=__codelineno-9-93></a><span class=w>                </span><span class=k>else</span><span class=w> </span><span class=o>-></span><span class=w> </span><span class=n>Transition</span><span class=p>.</span><span class=na>Retry</span>
<a href=#__codelineno-9-94 id=__codelineno-9-94 name=__codelineno-9-94></a><span class=w>            </span><span class=p>}</span>
<a href=#__codelineno-9-95 id=__codelineno-9-95 name=__codelineno-9-95></a><span class=w>        </span><span class=p>}</span>
<a href=#__codelineno-9-96 id=__codelineno-9-96 name=__codelineno-9-96></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-9-97 id=__codelineno-9-97 name=__codelineno-9-97></a>
<a href=#__codelineno-9-98 id=__codelineno-9-98 name=__codelineno-9-98></a><span class=w>    </span><span class=kd>object</span><span class=w> </span><span class=nc>FinishStep</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-99 id=__codelineno-9-99 name=__codelineno-9-99></a><span class=w>        </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>onEntry</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-100 id=__codelineno-9-100 name=__codelineno-9-100></a><span class=w>            </span><span class=kd>val</span><span class=w> </span><span class=nv>name</span><span class=p>:</span><span class=w> </span><span class=kt>String?</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>getState</span><span class=o>&lt;</span><span class=n>NameStep</span><span class=o>></span><span class=p>()</span>
<a href=#__codelineno-9-101 id=__codelineno-9-101 name=__codelineno-9-101></a><span class=w>            </span><span class=kd>val</span><span class=w> </span><span class=nv>age</span><span class=p>:</span><span class=w> </span><span class=kt>Int?</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>getState</span><span class=o>&lt;</span><span class=n>AgeStep</span><span class=o>></span><span class=p>()</span>
<a href=#__codelineno-9-102 id=__codelineno-9-102 name=__codelineno-9-102></a>
<a href=#__codelineno-9-103 id=__codelineno-9-103 name=__codelineno-9-103></a><span class=w>            </span><span class=c1>// Lưu vào cơ sở dữ liệu, gửi xác nhận, v.v.</span>
<a href=#__codelineno-9-104 id=__codelineno-9-104 name=__codelineno-9-104></a><span class=w>            </span><span class=n>message</span><span class=w> </span><span class=p>{</span><span class=w> </span>
<a href=#__codelineno-9-105 id=__codelineno-9-105 name=__codelineno-9-105></a><span class=w>                </span><span class=s>"Registration complete! Welcome, </span><span class=si>$</span><span class=n>name</span><span class=s> (age </span><span class=si>$</span><span class=n>age</span><span class=s>)."</span><span class=w> </span>
<a href=#__codelineno-9-106 id=__codelineno-9-106 name=__codelineno-9-106></a><span class=w>            </span><span class=p>}.</span><span class=na>send</span><span class=p>(</span><span class=n>ctx</span><span class=p>.</span><span class=na>user</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>bot</span><span class=p>)</span>
<a href=#__codelineno-9-107 id=__codelineno-9-107 name=__codelineno-9-107></a><span class=w>        </span><span class=p>}</span>
<a href=#__codelineno-9-108 id=__codelineno-9-108 name=__codelineno-9-108></a>
<a href=#__codelineno-9-109 id=__codelineno-9-109 name=__codelineno-9-109></a><span class=w>        </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>onRetry</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>Unit</span>
<a href=#__codelineno-9-110 id=__codelineno-9-110 name=__codelineno-9-110></a>
<a href=#__codelineno-9-111 id=__codelineno-9-111 name=__codelineno-9-111></a><span class=w>        </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>validate</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>):</span><span class=w> </span><span class=n>Transition</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-9-112 id=__codelineno-9-112 name=__codelineno-9-112></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>Transition</span><span class=p>.</span><span class=na>Finish</span>
<a href=#__codelineno-9-113 id=__codelineno-9-113 name=__codelineno-9-113></a><span class=w>        </span><span class=p>}</span>
<a href=#__codelineno-9-114 id=__codelineno-9-114 name=__codelineno-9-114></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-9-115 id=__codelineno-9-115 name=__codelineno-9-115></a><span class=p>}</span>
</code></pre></div> <hr> <h3 id=tinh-nang-nang-cao>Tính Năng Nâng Cao<a title="Permanent link" class=headerlink href=#tinh-nang-nang-cao>¶</a></h3> <h4 id=chuyen-tiep-co-ieu-kien>Chuyển Tiếp Có Điều Kiện<a title="Permanent link" class=headerlink href=#chuyen-tiep-co-ieu-kien>¶</a></h4> <p>Sử dụng <code>Transition.JumpTo</code> cho luồng có điều kiện:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-10-1 id=__codelineno-10-1 name=__codelineno-10-1></a><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>validate</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>):</span><span class=w> </span><span class=n>Transition</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-10-2 id=__codelineno-10-2 name=__codelineno-10-2></a><span class=w>    </span><span class=kd>val</span><span class=w> </span><span class=nv>choice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>update</span><span class=p>.</span><span class=na>text</span><span class=o>?.</span><span class=na>lowercase</span><span class=p>()</span>
<a href=#__codelineno-10-3 id=__codelineno-10-3 name=__codelineno-10-3></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>when</span><span class=w> </span><span class=p>(</span><span class=n>choice</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-10-4 id=__codelineno-10-4 name=__codelineno-10-4></a><span class=w>        </span><span class=s>"premium"</span><span class=w> </span><span class=o>-></span><span class=w> </span><span class=n>Transition</span><span class=p>.</span><span class=na>JumpTo</span><span class=p>(</span><span class=n>PremiumStep</span><span class=o>::</span><span class=n>class</span><span class=p>)</span>
<a href=#__codelineno-10-5 id=__codelineno-10-5 name=__codelineno-10-5></a><span class=w>        </span><span class=s>"basic"</span><span class=w> </span><span class=o>-></span><span class=w> </span><span class=n>Transition</span><span class=p>.</span><span class=na>JumpTo</span><span class=p>(</span><span class=n>BasicStep</span><span class=o>::</span><span class=n>class</span><span class=p>)</span>
<a href=#__codelineno-10-6 id=__codelineno-10-6 name=__codelineno-10-6></a><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=o>-></span><span class=w> </span><span class=n>Transition</span><span class=p>.</span><span class=na>Retry</span>
<a href=#__codelineno-10-7 id=__codelineno-10-7 name=__codelineno-10-7></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-10-8 id=__codelineno-10-8 name=__codelineno-10-8></a><span class=p>}</span>
</code></pre></div> <h4 id=cac-buoc-khong-co-trang-thai>Các Bước Không Có Trạng Thái<a title="Permanent link" class=headerlink href=#cac-buoc-khong-co-trang-thai>¶</a></h4> <p>Các bước không cần lưu trữ trạng thái. Đơn giản trả về <code>null</code> từ <code>store()</code> (hoặc giữ nguyên):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-11-1 id=__codelineno-11-1 name=__codelineno-11-1></a><span class=kd>object</span><span class=w> </span><span class=nc>ConfirmationStep</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-11-2 id=__codelineno-11-2 name=__codelineno-11-2></a><span class=w>    </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>store</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>):</span><span class=w> </span><span class=kt>Any?</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span>
<a href=#__codelineno-11-3 id=__codelineno-11-3 name=__codelineno-11-3></a><span class=w>    </span><span class=c1>// ... phần còn lại của triển khai</span>
<a href=#__codelineno-11-4 id=__codelineno-11-4 name=__codelineno-11-4></a><span class=p>}</span>
</code></pre></div> <h4 id=trinh-quan-ly-trang-thai-tuy-chinh>Trình Quản Lý Trạng Thái Tùy Chỉnh<a title="Permanent link" class=headerlink href=#trinh-quan-ly-trang-thai-tuy-chinh>¶</a></h4> <p>Triển khai <code>WizardStateManager&lt;T></code> cho lưu trữ tùy chỉnh (cơ sở dữ liệu, Redis, v.v.):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-12-1 id=__codelineno-12-1 name=__codelineno-12-1></a><span class=kd>class</span><span class=w> </span><span class=nc>DatabaseStateManager</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStateManager</span><span class=o>&lt;</span><span class=kt>String</span><span class=o>></span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-12-2 id=__codelineno-12-2 name=__codelineno-12-2></a><span class=w>    </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>get</span><span class=p>(</span>
<a href=#__codelineno-12-3 id=__codelineno-12-3 name=__codelineno-12-3></a><span class=w>        </span><span class=n>key</span><span class=p>:</span><span class=w> </span><span class=n>KClass</span><span class=o>&lt;</span><span class=k>out</span><span class=w> </span><span class=n>WizardStep</span><span class=o>></span><span class=p>,</span>
<a href=#__codelineno-12-4 id=__codelineno-12-4 name=__codelineno-12-4></a><span class=w>        </span><span class=n>reference</span><span class=p>:</span><span class=w> </span><span class=n>UserChatReference</span>
<a href=#__codelineno-12-5 id=__codelineno-12-5 name=__codelineno-12-5></a><span class=w>    </span><span class=p>):</span><span class=w> </span><span class=kt>String?</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-12-6 id=__codelineno-12-6 name=__codelineno-12-6></a><span class=w>        </span><span class=c1>// Tải từ cơ sở dữ liệu</span>
<a href=#__codelineno-12-7 id=__codelineno-12-7 name=__codelineno-12-7></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>database</span><span class=p>.</span><span class=na>getWizardState</span><span class=p>(</span><span class=n>reference</span><span class=p>.</span><span class=na>userId</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>qualifiedName</span><span class=p>)</span>
<a href=#__codelineno-12-8 id=__codelineno-12-8 name=__codelineno-12-8></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-12-9 id=__codelineno-12-9 name=__codelineno-12-9></a>
<a href=#__codelineno-12-10 id=__codelineno-12-10 name=__codelineno-12-10></a><span class=w>    </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>set</span><span class=p>(</span>
<a href=#__codelineno-12-11 id=__codelineno-12-11 name=__codelineno-12-11></a><span class=w>        </span><span class=n>key</span><span class=p>:</span><span class=w> </span><span class=n>KClass</span><span class=o>&lt;</span><span class=k>out</span><span class=w> </span><span class=n>WizardStep</span><span class=o>></span><span class=p>,</span>
<a href=#__codelineno-12-12 id=__codelineno-12-12 name=__codelineno-12-12></a><span class=w>        </span><span class=n>reference</span><span class=p>:</span><span class=w> </span><span class=n>UserChatReference</span><span class=p>,</span>
<a href=#__codelineno-12-13 id=__codelineno-12-13 name=__codelineno-12-13></a><span class=w>        </span><span class=n>value</span><span class=p>:</span><span class=w> </span><span class=kt>String</span>
<a href=#__codelineno-12-14 id=__codelineno-12-14 name=__codelineno-12-14></a><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-12-15 id=__codelineno-12-15 name=__codelineno-12-15></a><span class=w>        </span><span class=c1>// Lưu vào cơ sở dữ liệu</span>
<a href=#__codelineno-12-16 id=__codelineno-12-16 name=__codelineno-12-16></a><span class=w>        </span><span class=n>database</span><span class=p>.</span><span class=na>saveWizardState</span><span class=p>(</span><span class=n>reference</span><span class=p>.</span><span class=na>userId</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>qualifiedName</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>)</span>
<a href=#__codelineno-12-17 id=__codelineno-12-17 name=__codelineno-12-17></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-12-18 id=__codelineno-12-18 name=__codelineno-12-18></a>
<a href=#__codelineno-12-19 id=__codelineno-12-19 name=__codelineno-12-19></a><span class=w>    </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>del</span><span class=p>(</span>
<a href=#__codelineno-12-20 id=__codelineno-12-20 name=__codelineno-12-20></a><span class=w>        </span><span class=n>key</span><span class=p>:</span><span class=w> </span><span class=n>KClass</span><span class=o>&lt;</span><span class=k>out</span><span class=w> </span><span class=n>WizardStep</span><span class=o>></span><span class=p>,</span>
<a href=#__codelineno-12-21 id=__codelineno-12-21 name=__codelineno-12-21></a><span class=w>        </span><span class=n>reference</span><span class=p>:</span><span class=w> </span><span class=n>UserChatReference</span>
<a href=#__codelineno-12-22 id=__codelineno-12-22 name=__codelineno-12-22></a><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-12-23 id=__codelineno-12-23 name=__codelineno-12-23></a><span class=w>        </span><span class=c1>// Xóa khỏi cơ sở dữ liệu</span>
<a href=#__codelineno-12-24 id=__codelineno-12-24 name=__codelineno-12-24></a><span class=w>        </span><span class=n>database</span><span class=p>.</span><span class=na>deleteWizardState</span><span class=p>(</span><span class=n>reference</span><span class=p>.</span><span class=na>userId</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>qualifiedName</span><span class=p>)</span>
<a href=#__codelineno-12-25 id=__codelineno-12-25 name=__codelineno-12-25></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-12-26 id=__codelineno-12-26 name=__codelineno-12-26></a><span class=p>}</span>
</code></pre></div> <hr> <h3 id=cach-no-hoat-ong-ben-trong>Cách Nó Hoạt Động Bên Trong<a title="Permanent link" class=headerlink href=#cach-no-hoat-ong-ben-trong>¶</a></h3> <h4 id=tao-ma>Tạo Mã<a title="Permanent link" class=headerlink href=#tao-ma>¶</a></h4> <p>KSP tạo:</p> <ol><li><strong>WizardActivity</strong>: Một triển khai cụ thể mở rộng <code>WizardActivity</code> với các bước được mã hóa cứng<li><strong>Start Activity</strong>: Xử lý trình kích hoạt lệnh và bắt đầu wizard<li><strong>Input Activity</strong>: Xử lý đầu vào người dùng trong luồng wizard<li><strong>State Accessors</strong>: Các hàm mở rộng an toàn kiểu cho truy cập trạng thái</ol> <h4 id=luong>Luồng<a title="Permanent link" class=headerlink href=#luong>¶</a></h4> <ol><li>Người dùng gửi <code>/register</code> → Start Activity được gọi<li>Start Activity tạo <code>WizardContext</code> và gọi <code>wizardActivity.start(ctx)</code><li><code>start()</code> vào bước ban đầu và thiết lập <code>inputListener</code> để theo dõi bước hiện tại<li>Người dùng gửi tin nhắn → Input Activity được gọi<li>Input Activity gọi <code>wizardActivity.handleInput(ctx)</code><li><code>handleInput()</code> xác thực đầu vào, lưu trữ trạng thái và chuyển tiếp sang bước tiếp theo<li>Quá trình lặp lại cho đến khi <code>Transition.Finish</code> được trả về</ol> <h4 id=luu-tru-trang-thai>Lưu Trữ Trạng Thái<a title="Permanent link" class=headerlink href=#luu-tru-trang-thai>¶</a></h4> <ul><li>Trạng thái được lưu trữ sau khi xác thực thành công (trước khi chuyển tiếp)<li>Giá trị trả về của <code>store()</code> cho mỗi bước được lưu trữ sử dụng <code>WizardStateManager</code> khớp<li>Trạng thái được giới hạn theo người dùng và chat (<code>UserChatReference</code>)</ul> <hr> <h3 id=thuc-hanh-tot-nhat>Thực Hành Tốt Nhất<a title="Permanent link" class=headerlink href=#thuc-hanh-tot-nhat>¶</a></h3> <h4 id=1-luon-cung-cap-loi-nhac-ro-rang>1. Luôn Cung Cấp Lời Nhắc Rõ Ràng<a title="Permanent link" class=headerlink href=#1-luon-cung-cap-loi-nhac-ro-rang>¶</a></h4> <div class=highlight><pre><span></span><code><a href=#__codelineno-13-1 id=__codelineno-13-1 name=__codelineno-13-1></a><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>onEntry</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-13-2 id=__codelineno-13-2 name=__codelineno-13-2></a><span class=w>    </span><span class=n>message</span><span class=w> </span><span class=p>{</span><span class=w> </span>
<a href=#__codelineno-13-3 id=__codelineno-13-3 name=__codelineno-13-3></a><span class=w>        </span><span class=s>"Please enter your email address:\n"</span><span class=w> </span><span class=o>+</span>
<a href=#__codelineno-13-4 id=__codelineno-13-4 name=__codelineno-13-4></a><span class=w>        </span><span class=s>"(Format: user@example.com)"</span><span class=w> </span>
<a href=#__codelineno-13-5 id=__codelineno-13-5 name=__codelineno-13-5></a><span class=w>    </span><span class=p>}.</span><span class=na>send</span><span class=p>(</span><span class=n>ctx</span><span class=p>.</span><span class=na>user</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>bot</span><span class=p>)</span>
<a href=#__codelineno-13-6 id=__codelineno-13-6 name=__codelineno-13-6></a><span class=p>}</span>
</code></pre></div> <h4 id=2-xu-ly-loi-xac-thuc-mot-cach-lich-su>2. Xử Lý Lỗi Xác Thực Một Cách Lịch Sự<a title="Permanent link" class=headerlink href=#2-xu-ly-loi-xac-thuc-mot-cach-lich-su>¶</a></h4> <div class=highlight><pre><span></span><code><a href=#__codelineno-14-1 id=__codelineno-14-1 name=__codelineno-14-1></a><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>onRetry</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-14-2 id=__codelineno-14-2 name=__codelineno-14-2></a><span class=w>    </span><span class=n>message</span><span class=w> </span><span class=p>{</span><span class=w> </span>
<a href=#__codelineno-14-3 id=__codelineno-14-3 name=__codelineno-14-3></a><span class=w>        </span><span class=s>"Invalid email format. Please try again.\n"</span><span class=w> </span><span class=o>+</span>
<a href=#__codelineno-14-4 id=__codelineno-14-4 name=__codelineno-14-4></a><span class=w>        </span><span class=s>"Example: user@example.com"</span><span class=w> </span>
<a href=#__codelineno-14-5 id=__codelineno-14-5 name=__codelineno-14-5></a><span class=w>    </span><span class=p>}.</span><span class=na>send</span><span class=p>(</span><span class=n>ctx</span><span class=p>.</span><span class=na>user</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>bot</span><span class=p>)</span>
<a href=#__codelineno-14-6 id=__codelineno-14-6 name=__codelineno-14-6></a><span class=p>}</span>
</code></pre></div> <h4 id=3-su-dung-truy-cap-trang-thai-an-toan-kieu>3. Sử Dụng Truy Cập Trạng Thái An Toàn Kiểu<a title="Permanent link" class=headerlink href=#3-su-dung-truy-cap-trang-thai-an-toan-kieu>¶</a></h4> <p>Thích các phương thức an toàn kiểu được tạo:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-15-1 id=__codelineno-15-1 name=__codelineno-15-1></a><span class=c1>// ✅ Tốt - an toàn kiểu</span>
<a href=#__codelineno-15-2 id=__codelineno-15-2 name=__codelineno-15-2></a><span class=kd>val</span><span class=w> </span><span class=nv>name</span><span class=p>:</span><span class=w> </span><span class=kt>String?</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>getState</span><span class=o>&lt;</span><span class=n>NameStep</span><span class=o>></span><span class=p>()</span>
<a href=#__codelineno-15-3 id=__codelineno-15-3 name=__codelineno-15-3></a>
<a href=#__codelineno-15-4 id=__codelineno-15-4 name=__codelineno-15-4></a><span class=c1>// ❌ Tránh - mất an toàn kiểu</span>
<a href=#__codelineno-15-5 id=__codelineno-15-5 name=__codelineno-15-5></a><span class=kd>val</span><span class=w> </span><span class=nv>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>getState</span><span class=p>(</span><span class=n>NameStep</span><span class=o>::</span><span class=n>class</span><span class=p>)</span><span class=w> </span><span class=k>as?</span><span class=w> </span><span class=kt>String</span>
</code></pre></div> <h4 id=4-giu-cac-buoc-tap-trung>4. Giữ Các Bước Tập Trung<a title="Permanent link" class=headerlink href=#4-giu-cac-buoc-tap-trung>¶</a></h4> <p>Mỗi bước nên có một trách nhiệm duy nhất:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-16-1 id=__codelineno-16-1 name=__codelineno-16-1></a><span class=c1>// ✅ Tốt - bước tập trung</span>
<a href=#__codelineno-16-2 id=__codelineno-16-2 name=__codelineno-16-2></a><span class=kd>object</span><span class=w> </span><span class=nc>EmailStep</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-16-3 id=__codelineno-16-3 name=__codelineno-16-3></a><span class=w>    </span><span class=c1>// Chỉ xử lý thu thập email</span>
<a href=#__codelineno-16-4 id=__codelineno-16-4 name=__codelineno-16-4></a><span class=p>}</span>
<a href=#__codelineno-16-5 id=__codelineno-16-5 name=__codelineno-16-5></a>
<a href=#__codelineno-16-6 id=__codelineno-16-6 name=__codelineno-16-6></a><span class=c1>// ❌ Tránh - quá nhiều logic</span>
<a href=#__codelineno-16-7 id=__codelineno-16-7 name=__codelineno-16-7></a><span class=kd>object</span><span class=w> </span><span class=nc>PersonalInfoStep</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-16-8 id=__codelineno-16-8 name=__codelineno-16-8></a><span class=w>    </span><span class=c1>// Xử lý tên, email, điện thoại, địa chỉ...</span>
<a href=#__codelineno-16-9 id=__codelineno-16-9 name=__codelineno-16-9></a><span class=p>}</span>
</code></pre></div> <h4 id=5-su-dung-ten-buoc-co-y-nghia>5. Sử Dụng Tên Bước Có Ý Nghĩa<a title="Permanent link" class=headerlink href=#5-su-dung-ten-buoc-co-y-nghia>¶</a></h4> <div class=highlight><pre><span></span><code><a href=#__codelineno-17-1 id=__codelineno-17-1 name=__codelineno-17-1></a><span class=c1>// ✅ Tốt</span>
<a href=#__codelineno-17-2 id=__codelineno-17-2 name=__codelineno-17-2></a><span class=kd>object</span><span class=w> </span><span class=nc>EmailVerificationStep</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span>
<a href=#__codelineno-17-3 id=__codelineno-17-3 name=__codelineno-17-3></a>
<a href=#__codelineno-17-4 id=__codelineno-17-4 name=__codelineno-17-4></a><span class=c1>// ❌ Tránh</span>
<a href=#__codelineno-17-5 id=__codelineno-17-5 name=__codelineno-17-5></a><span class=kd>object</span><span class=w> </span><span class=nc>Step2</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span>
</code></pre></div> <h4 id=6-don-dep-trang-thai-khi-can>6. Dọn Dẹp Trạng Thái Khi Cần<a title="Permanent link" class=headerlink href=#6-don-dep-trang-thai-khi-can>¶</a></h4> <p>Nếu bạn cần xóa trạng thái thủ công:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-18-1 id=__codelineno-18-1 name=__codelineno-18-1></a><span class=kd>object</span><span class=w> </span><span class=nc>CancelStep</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>WizardStep</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-18-2 id=__codelineno-18-2 name=__codelineno-18-2></a><span class=w>    </span><span class=kd>override</span><span class=w> </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>onEntry</span><span class=p>(</span><span class=n>ctx</span><span class=p>:</span><span class=w> </span><span class=n>WizardContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a href=#__codelineno-18-3 id=__codelineno-18-3 name=__codelineno-18-3></a><span class=w>        </span><span class=c1>// Xóa tất cả trạng thái wizard</span>
<a href=#__codelineno-18-4 id=__codelineno-18-4 name=__codelineno-18-4></a><span class=w>        </span><span class=n>ctx</span><span class=p>.</span><span class=na>delState</span><span class=o>&lt;</span><span class=n>NameStep</span><span class=o>></span><span class=p>()</span>
<a href=#__codelineno-18-5 id=__codelineno-18-5 name=__codelineno-18-5></a><span class=w>        </span><span class=n>ctx</span><span class=p>.</span><span class=na>delState</span><span class=o>&lt;</span><span class=n>AgeStep</span><span class=o>></span><span class=p>()</span>
<a href=#__codelineno-18-6 id=__codelineno-18-6 name=__codelineno-18-6></a>
<a href=#__codelineno-18-7 id=__codelineno-18-7 name=__codelineno-18-7></a><span class=w>        </span><span class=n>message</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>"Registration cancelled."</span><span class=w> </span><span class=p>}.</span><span class=na>send</span><span class=p>(</span><span class=n>ctx</span><span class=p>.</span><span class=na>user</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>bot</span><span class=p>)</span>
<a href=#__codelineno-18-8 id=__codelineno-18-8 name=__codelineno-18-8></a><span class=w>    </span><span class=p>}</span>
<a href=#__codelineno-18-9 id=__codelineno-18-9 name=__codelineno-18-9></a><span class=p>}</span>
</code></pre></div> <hr> <h3 id=tom-tat>Tóm Tắt<a title="Permanent link" class=headerlink href=#tom-tat>¶</a></h3> <p>Hệ thống Wizard cung cấp: - ✅ <strong>An toàn kiểu</strong> quản lý trạng thái với kiểm tra tại thời gian biên dịch - ✅ <strong>Khai báo</strong> định nghĩa bước dưới dạng lớp lồng nhau - ✅ <strong>Linh hoạt</strong> chuyển tiếp với logic có điều kiện - ✅ <strong>Tự động</strong> tạo mã qua KSP - ✅ <strong>Tích hợp</strong> với hệ thống Activity hiện có - ✅ <strong>Có thể cắm được</strong> backend lưu trữ trạng thái</p> <p>Bắt đầu xây dựng wizard bằng cách chú thích một lớp với <code>@WizardHandler</code> và định nghĩa các bước của bạn dưới dạng các đối tượng <code>WizardStep</code> lồng nhau! nếu bạn có bất kỳ câu hỏi nào liên hệ với chúng tôi trong chat, chúng tôi sẽ rất vui được giúp đỡ :)</p> <hr> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> <button class="md-top md-icon" data-md-component=top hidden type=button><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Trở lại mục lục</button> <footer class=md-footer><nav aria-label="Chân trang" class="md-footer__inner md-grid"><a aria-label="Trước: Câu hỏi thường gặp" class="md-footer__link md-footer__link--prev" href=../F.A.Q/> <div class="md-footer__button md-icon"><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg></div> <div class=md-footer__title><span class=md-footer__direction> Trước </span><div class=md-ellipsis>Câu hỏi thường gặp</div></div> </a><a aria-label="Sau: Functional Dsl" class="md-footer__link md-footer__link--next" href=../Functional-DSL/> <div class=md-footer__title><span class=md-footer__direction> Sau </span><div class=md-ellipsis>Functional Dsl</div></div> <div class="md-footer__button md-icon"><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg></div> </a></nav><div class="md-footer-meta md-typeset"><div class="md-footer-meta__inner md-grid"><div class=md-copyright>Made with <a href=https://squidfunk.github.io/mkdocs-material/ rel=noopener target=_blank> Material for MkDocs </a></div></div></div></footer> <div class=md-dialog data-md-component=dialog><div class="md-dialog__inner md-typeset"></div></div> <script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["content.code.annotate", "content.code.copy", "navigation.footer", "navigation.tabs", "navigation.top", "navigation.tracking", "search.share", "toc.follow"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "\u0110\u00e3 sao ch\u00e9p", "clipboard.copy": "Sao ch\u00e9p v\u00e0o b\u1ed9 nh\u1edb t\u1ea1m", "search.result.more.one": "1 t\u1eeb kh\u00e1c trong trang", "search.result.more.other": "# t\u1eeb kh\u00e1c trong trang", "search.result.none": "Kh\u00f4ng t\u00ecm th\u1ea5y t\u00e0i li\u1ec7u li\u00ean quan", "search.result.one": "1 t\u00e0i li\u1ec7u li\u00ean quan", "search.result.other": "# t\u00e0i li\u1ec7u li\u00ean quan", "search.result.placeholder": "Nh\u1eadp \u0111\u1ec3 b\u1eaft \u0111\u1ea7u t\u00ecm ki\u1ebfm", "search.result.term.missing": "Kh\u00f4ng", "select.version": "Ch\u1ecdn phi\u00ean b\u1ea3n"}, "version": null}</script> <script src=../../assets/javascripts/bundle.79ae519e.min.js></script> 